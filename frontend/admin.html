<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פאנל ניהול אדמין - מערכת תורמים</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --admin-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --success-gradient: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            --warning-gradient: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
            --info-gradient: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            --danger-gradient: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            --dark-gradient: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            
            --primary-color: #667eea;
            --admin-primary: #ff6b6b;
            --admin-secondary: #ee5a24;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --info-color: #74b9ff;
            --danger-color: #fd79a8;
            --dark-color: #2d3436;
            
            --bg-light: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #f1f3f4;
            --border-color: #e2e8f0;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --text-muted: #a0aec0;
            
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.15);
            --shadow-2xl: 0 25px 50px rgba(0,0,0,0.25);
            
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            
            --font-sm: 0.875rem;
            --font-base: 1rem;
            --font-lg: 1.125rem;
            --font-xl: 1.25rem;
            --font-2xl: 1.5rem;
            --font-3xl: 1.875rem;
            --font-4xl: 2.25rem;
        }
        
        body { 
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #e2e8f0;
            --bg-light: #1a202c;
            --bg-card: #2d3748;
            --bg-input: #4a5568;
            --border-color: #4a5568;
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e0;
            --text-muted: #a0aec0;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 24px; 
        }
        
        /* Header */
        .admin-header { 
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: white;
            border-radius: var(--radius-2xl);
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-2xl);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .admin-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--admin-gradient);
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
        }
        
        .admin-header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
            animation: floating 8s ease-in-out infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px) translateX(0px); }
            50% { transform: translateY(-20px) translateX(20px); }
        }
        
        .admin-header h1 {
            font-size: var(--font-4xl);
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
            position: relative;
            z-index: 2;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .admin-subtitle {
            font-size: var(--font-lg);
            opacity: 0.9;
            margin-bottom: 24px;
            position: relative;
            z-index: 2;
            font-weight: 400;
        }
        
        .admin-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            position: relative;
            z-index: 2;
        }
        
        .admin-welcome {
            background: rgba(255,255,255,0.15);
            padding: 12px 24px;
            border-radius: var(--radius-2xl);
            font-weight: 600;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: var(--shadow-lg);
        }
        
        /* Modern Buttons */
        .btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius-lg);
            font-size: var(--font-sm);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            letter-spacing: 0.025em;
            text-transform: uppercase;
            font-size: 12px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }
        
        .btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        .btn-admin { 
            background: var(--admin-gradient);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
        .btn-admin:hover {
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }
        
        .btn-sm { 
            padding: 8px 16px; 
            font-size: 11px; 
        }
        .btn-lg { 
            padding: 16px 32px; 
            font-size: var(--font-base); 
            border-radius: var(--radius-xl);
        }
        
        .btn-danger { 
            background: var(--danger-gradient);
            box-shadow: 0 4px 15px rgba(253, 121, 168, 0.4);
        }
        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(253, 121, 168, 0.6);
        }
        
        .btn-success { 
            background: var(--success-gradient);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
        }
        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(0, 184, 148, 0.6);
        }
        
        .btn-warning { 
            background: var(--warning-gradient);
            color: #2d3436;
            box-shadow: 0 4px 15px rgba(253, 203, 110, 0.4);
        }
        .btn-warning:hover {
            box-shadow: 0 8px 25px rgba(253, 203, 110, 0.6);
        }
        
        .btn-info { 
            background: var(--info-gradient);
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.4);
        }
        .btn-info:hover {
            box-shadow: 0 8px 25px rgba(116, 185, 255, 0.6);
        }
        
        .btn-secondary { 
            background: var(--dark-gradient);
            box-shadow: 0 4px 15px rgba(45, 52, 54, 0.4);
        }
        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(45, 52, 54, 0.6);
        }
        
        /* Modern Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-2xl);
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            opacity: 0.5;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-2xl);
            border-color: var(--primary-color);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
            position: relative;
        }
        
        .card-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: var(--admin-gradient);
            border-radius: 2px;
        }
        
        .card-title {
            font-size: var(--font-2xl);
            font-weight: 700;
            color: var(--admin-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }
        
        .dark-mode .card-title {
            color: #ff6b6b;
        }
        
        /* Modern Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: var(--bg-card);
            padding: 32px;
            border-radius: var(--radius-2xl);
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--admin-gradient);
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,107,107,0.05) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stat-card:hover::after {
            transform: scale(1);
        }
        
        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-2xl);
            border-color: var(--admin-primary);
        }
        
        .stat-icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
            position: relative;
            z-index: 2;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .stat-number {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 8px;
            display: block;
            position: relative;
            z-index: 2;
            background: var(--admin-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--text-secondary);
            position: relative;
            z-index: 2;
        }
        
        .stat-change {
            font-size: var(--font-sm);
            margin-top: 12px;
            padding: 6px 12px;
            border-radius: var(--radius-2xl);
            background: rgba(0,184,148,0.1);
            color: var(--success-color);
            font-weight: 600;
            position: relative;
            z-index: 2;
        }
        
        /* Modern Navigation */
        .admin-nav {
            background: var(--bg-card);
            border-radius: var(--radius-2xl);
            padding: 8px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-lg);
            display: flex;
            gap: 4px;
            overflow-x: auto;
            position: sticky;
            top: 24px;
            z-index: 100;
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
        }
        
        .nav-tab {
            padding: 16px 24px;
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            font-weight: 600;
            font-size: var(--font-sm);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .nav-tab:hover {
            background: var(--bg-light);
            color: var(--admin-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .nav-tab.active {
            background: var(--admin-gradient);
            color: white;
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }
        
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid var(--admin-primary);
        }
        
        /* Modern Tables */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-2xl);
            background: var(--bg-card);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-sm);
        }
        
        .table th,
        .table td {
            padding: 20px 16px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table th {
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-card) 100%);
            font-weight: 700;
            color: var(--admin-primary);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .table tbody tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .table tbody tr:hover {
            background: linear-gradient(135deg, var(--bg-light) 0%, rgba(255,107,107,0.05) 100%);
            transform: scale(1.01);
            box-shadow: var(--shadow-md);
        }
        
        .table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .table tbody tr.selected {
            background: linear-gradient(135deg, rgba(255,107,107,0.1) 0%, rgba(255,107,107,0.05) 100%);
            border-left: 4px solid var(--admin-primary);
        }
        
        /* Modern Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-sm);
        }
        
        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-size: var(--font-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-input);
            color: var(--text-primary);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--admin-primary);
            box-shadow: 0 0 0 4px rgba(255,107,107,0.1);
            transform: translateY(-1px);
            background: var(--bg-card);
        }
        
        /* Search and Filters */
        .search-filters {
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-card) 100%);
            padding: 24px;
            border-radius: var(--radius-2xl);
            margin-bottom: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            align-items: end;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }
        
        /* Modern Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(12px);
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-2xl);
            padding: 32px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-2xl);
            border: 1px solid var(--border-color);
        }
        
        @keyframes modalSlide {
            from { 
                opacity: 0; 
                transform: scale(0.9) translateY(-30px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
            position: relative;
        }
        
        .modal-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: var(--admin-gradient);
            border-radius: 2px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: var(--danger-color);
            background: rgba(253, 121, 168, 0.1);
            transform: rotate(90deg) scale(1.1);
        }
        
        /* Modern Messages */
        .message {
            padding: 20px 24px;
            border-radius: var(--radius-xl);
            margin-bottom: 16px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 16px;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            box-shadow: var(--shadow-md);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .message.success {
            background: linear-gradient(135deg, rgba(0,184,148,0.1) 0%, rgba(0,184,148,0.05) 100%);
            color: #00695c;
            border-color: var(--success-color);
        }
        
        .message.error {
            background: linear-gradient(135deg, rgba(253,121,168,0.1) 0%, rgba(253,121,168,0.05) 100%);
            color: #ad1457;
            border-color: var(--danger-color);
        }
        
        .message.warning {
            background: linear-gradient(135deg, rgba(253,203,110,0.1) 0%, rgba(253,203,110,0.05) 100%);
            color: #f57f17;
            border-color: var(--warning-color);
        }
        
        .message.info {
            background: linear-gradient(135deg, rgba(116,185,255,0.1) 0%, rgba(116,185,255,0.05) 100%);
            color: #1565c0;
            border-color: var(--info-color);
        }
        
        /* Charts Container */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .chart-container {
            background: var(--bg-card);
            border-radius: var(--radius-2xl);
            padding: 32px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }
        
        .chart-container h3,
        .chart-container h5 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-weight: 700;
        }
        
        /* Upload Area */
        .upload-area {
            border: 3px dashed var(--admin-primary);
            border-radius: var(--radius-2xl);
            padding: 48px 32px;
            text-align: center;
            margin-bottom: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, rgba(255,107,107,0.05) 0%, rgba(255,107,107,0.02) 100%);
            position: relative;
            overflow: hidden;
        }
        
        .upload-area::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,107,107,0.1) 0%, transparent 70%);
            border-radius: 50%;
            animation: pulse 3s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.3; }
        }
        
        .upload-area:hover {
            border-color: var(--admin-secondary);
            background: linear-gradient(135deg, rgba(255,107,107,0.1) 0%, rgba(255,107,107,0.05) 100%);
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .upload-area.dragover {
            border-color: var(--success-color);
            background: linear-gradient(135deg, rgba(0,184,148,0.1) 0%, rgba(0,184,148,0.05) 100%);
        }
        
        .upload-area > * {
            position: relative;
            z-index: 2;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--admin-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-muted);
        }
		
		.empty-state-icon {
           font-size: 80px;
           margin-bottom: 24px;
           opacity: 0.6;
           filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
       }
       
       .empty-state h3 {
           margin-bottom: 16px;
           color: var(--text-secondary);
           font-size: var(--font-2xl);
           font-weight: 600;
       }
       
       .empty-state p {
           font-size: var(--font-lg);
           margin-bottom: 24px;
           line-height: 1.6;
       }
       
       /* Modern Badges */
       .badge {
           display: inline-flex;
           align-items: center;
           padding: 6px 12px;
           border-radius: var(--radius-2xl);
           font-size: 11px;
           font-weight: 700;
           text-transform: uppercase;
           letter-spacing: 0.05em;
           box-shadow: var(--shadow-sm);
           transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
       }
       
       .badge:hover {
           transform: scale(1.05);
           box-shadow: var(--shadow-md);
       }
       
       .badge-success { 
           background: linear-gradient(135deg, var(--success-color) 0%, #00a085 100%);
           color: white; 
       }
       .badge-danger { 
           background: linear-gradient(135deg, var(--danger-color) 0%, #e84393 100%);
           color: white; 
       }
       .badge-warning { 
           background: linear-gradient(135deg, var(--warning-color) 0%, #e17055 100%);
           color: #2d3436; 
       }
       .badge-info { 
           background: linear-gradient(135deg, var(--info-color) 0%, #0984e3 100%);
           color: white; 
       }
       .badge-secondary { 
           background: linear-gradient(135deg, var(--text-muted) 0%, #718096 100%);
           color: white; 
       }
       
       /* Modern Pagination */
       .pagination {
           display: flex;
           justify-content: center;
           align-items: center;
           gap: 8px;
           margin-top: 32px;
       }
       
       .pagination button {
           padding: 12px 16px;
           border: 2px solid var(--border-color);
           background: var(--bg-card);
           border-radius: var(--radius-lg);
           cursor: pointer;
           transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
           font-weight: 600;
           color: var(--text-primary);
           min-width: 44px;
           box-shadow: var(--shadow-sm);
       }
       
       .pagination button:hover {
           background: var(--admin-primary);
           color: white;
           border-color: var(--admin-primary);
           transform: translateY(-2px);
           box-shadow: var(--shadow-md);
       }
       
       .pagination button.active {
           background: var(--admin-gradient);
           color: white;
           border-color: var(--admin-primary);
           box-shadow: var(--shadow-lg);
       }
       
       .pagination button:disabled {
           opacity: 0.4;
           cursor: not-allowed;
           transform: none;
       }
       
       .pagination button:disabled:hover {
           background: var(--bg-card);
           color: var(--text-primary);
           border-color: var(--border-color);
           transform: none;
           box-shadow: var(--shadow-sm);
       }
       
       /* Toolbar */
       .toolbar {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 24px;
           flex-wrap: wrap;
           gap: 16px;
           padding: 16px 0;
       }
       
       .toolbar-left,
       .toolbar-right {
           display: flex;
           align-items: center;
           gap: 12px;
           flex-wrap: wrap;
       }
       
       /* Dark Mode Toggle */
       .dark-mode-toggle {
           background: var(--admin-gradient);
           color: white;
           border: none;
           border-radius: var(--radius-2xl);
           padding: 12px 20px;
           cursor: pointer;
           font-size: var(--font-sm);
           transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
           display: flex;
           align-items: center;
           gap: 8px;
           font-weight: 600;
           box-shadow: var(--shadow-md);
       }
       
       .dark-mode-toggle:hover {
           transform: scale(1.05) translateY(-2px);
           box-shadow: var(--shadow-lg);
       }
       
       /* Selection Controls */
       .selection-controls {
           background: var(--admin-gradient);
           color: white;
           padding: 20px 24px;
           border-radius: var(--radius-xl);
           margin-bottom: 24px;
           display: none;
           align-items: center;
           justify-content: space-between;
           flex-wrap: wrap;
           gap: 16px;
           box-shadow: var(--shadow-lg);
           backdrop-filter: blur(20px);
       }
       
       .selection-controls.show {
           display: flex;
           animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
       }
       
       @keyframes slideDown {
           from { opacity: 0; transform: translateY(-20px); }
           to { opacity: 1; transform: translateY(0); }
       }
       
       /* Progress Bar */
       .progress {
           width: 100%;
           height: 12px;
           background: var(--bg-light);
           border-radius: var(--radius-lg);
           overflow: hidden;
           margin: 16px 0;
           box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
       }
       
       .progress-bar {
           height: 100%;
           background: var(--admin-gradient);
           transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
           border-radius: var(--radius-lg);
           position: relative;
       }
       
       .progress-bar::after {
           content: '';
           position: absolute;
           top: 0;
           left: 0;
           bottom: 0;
           right: 0;
           background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
           animation: progressShine 2s ease-in-out infinite;
       }
       
       @keyframes progressShine {
           0% { transform: translateX(-100%); }
           50% { transform: translateX(100%); }
           100% { transform: translateX(100%); }
       }
       
       /* Sort Indicators */
       .sort-indicator {
           margin-left: 8px;
           color: var(--text-muted);
           font-size: 12px;
           transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
       }
       
       .table th:hover .sort-indicator {
           color: var(--admin-primary);
           transform: scale(1.2);
       }
       
       /* Notification Toast */
       .notification-toast {
           position: fixed;
           top: 24px;
           left: 50%;
           transform: translateX(-50%);
           z-index: 9999;
           min-width: 350px;
           max-width: 600px;
           text-align: center;
           box-shadow: var(--shadow-2xl);
           animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
           backdrop-filter: blur(20px);
           border: 1px solid rgba(255,255,255,0.2);
           border-radius: var(--radius-xl);
       }
       
       /* Custom Scrollbar */
       ::-webkit-scrollbar {
           width: 8px;
           height: 8px;
       }
       
       ::-webkit-scrollbar-track {
           background: var(--bg-light);
           border-radius: var(--radius-lg);
       }
       
       ::-webkit-scrollbar-thumb {
           background: var(--admin-gradient);
           border-radius: var(--radius-lg);
           transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
       }
       
       ::-webkit-scrollbar-thumb:hover {
           background: linear-gradient(135deg, #ee5a24 0%, #ff6b6b 100%);
       }
       
       /* Hover Effects for Interactive Elements */
       .card:hover .card-title {
           color: var(--admin-secondary);
           transform: translateX(4px);
       }
       
       .table tbody tr:hover .btn {
           transform: scale(1.05);
       }
       
       /* Focus States */
       .btn:focus,
       .form-control:focus,
       .nav-tab:focus {
           outline: 2px solid var(--admin-primary);
           outline-offset: 2px;
       }
       
       /* Utility Classes */
       .hidden { display: none !important; }
       .text-center { text-align: center; }
       .text-right { text-align: right; }
       .text-left { text-align: left; }
       .text-muted { color: var(--text-muted); }
       .mb-0 { margin-bottom: 0; }
       .mb-10 { margin-bottom: 10px; }
       .mb-20 { margin-bottom: 20px; }
       .mt-20 { margin-top: 20px; }
       .p-20 { padding: 20px; }
       .fw-bold { font-weight: 700; }
       .fs-small { font-size: var(--font-sm); }
       .cursor-pointer { cursor: pointer; }
       
       /* Glassmorphism Effect */
       .glass {
           background: rgba(255, 255, 255, 0.1);
           backdrop-filter: blur(20px);
           border: 1px solid rgba(255, 255, 255, 0.2);
       }
       
       /* Floating Action Elements */
       .floating {
           animation: floating 3s ease-in-out infinite;
       }
       
       /* Pulse Animation for Important Elements */
       .pulse {
           animation: pulse 2s ease-in-out infinite;
       }
       
       /* Glow Effect */
       .glow {
           box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
       }
       
       .glow:hover {
           box-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
       }
       
       /* Enhanced Input Focus */
       .form-control:focus {
           background: var(--bg-card);
           transform: translateY(-2px);
           box-shadow: 
               0 0 0 4px rgba(255,107,107,0.1),
               0 8px 25px rgba(0,0,0,0.1);
       }
       
       /* Modern Checkbox Styling */
       input[type="checkbox"] {
           appearance: none;
           width: 20px;
           height: 20px;
           border: 2px solid var(--border-color);
           border-radius: var(--radius-sm);
           background: var(--bg-card);
           cursor: pointer;
           transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
           position: relative;
       }
       
       input[type="checkbox"]:checked {
           background: var(--admin-gradient);
           border-color: var(--admin-primary);
           transform: scale(1.1);
       }
       
       input[type="checkbox"]:checked::after {
           content: '✓';
           position: absolute;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
           color: white;
           font-weight: 700;
           font-size: 12px;
       }
       
       input[type="checkbox"]:hover {
           border-color: var(--admin-primary);
           box-shadow: 0 0 0 3px rgba(255,107,107,0.1);
       }
       
       /* Responsive Design */
       @media (max-width: 1200px) {
           .stats-grid { 
               grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
           }
           .charts-grid { 
               grid-template-columns: 1fr; 
           }
           .container { 
               padding: 16px; 
           }
       }
       
       @media (max-width: 768px) {
           .admin-header { 
               padding: 24px; 
               text-align: center; 
           }
           .admin-header h1 { 
               font-size: var(--font-3xl); 
               flex-direction: column; 
           }
           .admin-controls { 
               width: 100%; 
               justify-content: center; 
           }
           .admin-nav { 
               flex-direction: column; 
               padding: 4px;
           }
           .nav-tab {
               width: 100%;
               justify-content: center;
           }
           .stats-grid { 
               grid-template-columns: 1fr; 
               gap: 16px;
           }
           .form-row { 
               grid-template-columns: 1fr; 
           }
           .search-filters { 
               grid-template-columns: 1fr; 
               padding: 16px;
           }
           .modal-content { 
               width: 95%; 
               padding: 24px; 
               margin: 16px;
           }
           .toolbar { 
               flex-direction: column; 
               align-items: stretch; 
           }
           .table-container { 
               font-size: 12px; 
           }
           .table th, 
           .table td { 
               padding: 12px 8px; 
           }
           .card {
               padding: 20px;
               margin-bottom: 20px;
           }
           .stat-card {
               padding: 24px;
           }
           .stat-number {
               font-size: 36px;
           }
       }
       
       @media (max-width: 480px) {
           .admin-header h1 { 
               font-size: var(--font-2xl); 
           }
           .stat-number { 
               font-size: 32px; 
           }
           .stat-icon { 
               font-size: 36px; 
           }
           .card { 
               padding: 16px; 
           }
           .nav-tab { 
               padding: 12px 16px; 
               font-size: 11px;
           }
           .btn {
               padding: 10px 16px;
               font-size: 11px;
           }
           .btn-lg {
               padding: 14px 24px;
               font-size: var(--font-sm);
           }
       }
       
       /* Print Styles */
       @media print {
           .admin-nav,
           .admin-controls,
           .btn,
           .modal {
               display: none !important;
           }
           
           .card {
               box-shadow: none;
               border: 1px solid #ccc;
           }
           
           body {
               background: white;
               color: black;
           }
       }
       
       /* High Contrast Mode */
       @media (prefers-contrast: high) {
           :root {
               --border-color: #000;
               --text-primary: #000;
               --bg-card: #fff;
           }
           
           .btn {
               border: 2px solid #000;
           }
       }
       
       /* Reduced Motion */
       @media (prefers-reduced-motion: reduce) {
           * {
               animation-duration: 0.01ms !important;
               animation-iteration-count: 1 !important;
               transition-duration: 0.01ms !important;
           }
       }
       
       /* Dark mode specific improvements */
       .dark-mode .table tbody tr:hover {
           background: linear-gradient(135deg, rgba(255,107,107,0.1) 0%, rgba(255,107,107,0.05) 100%);
       }
       
       .dark-mode .form-control {
           background: rgba(255,255,255,0.05);
           border-color: rgba(255,255,255,0.1);
       }
       
       .dark-mode .form-control:focus {
           background: rgba(255,255,255,0.1);
           border-color: var(--admin-primary);
       }
       
       .dark-mode .search-filters {
           background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
       }
       
       .dark-mode .upload-area {
           background: linear-gradient(135deg, rgba(255,107,107,0.1) 0%, rgba(255,107,107,0.05) 100%);
       }
       
       /* Enhanced button states */
       .btn:disabled {
           opacity: 0.6;
           cursor: not-allowed;
           transform: none !important;
       }
       
       .btn:disabled:hover {
           transform: none !important;
           box-shadow: var(--shadow-md) !important;
       }
       
       /* Table enhancements */
       .table thead th {
           background: linear-gradient(135deg, var(--bg-light) 0%, rgba(255,107,107,0.05) 100%);
           border-bottom: 2px solid var(--admin-primary);
       }
       
       /* Enhanced modal backdrop */
       .modal {
           background: linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(45,52,54,0.6) 100%);
       }
       
       /* Selection highlight */
       ::selection {
           background: rgba(255,107,107,0.2);
           color: var(--text-primary);
       }
       
       /* Enhanced focus rings */
       *:focus-visible {
           outline: 2px solid var(--admin-primary);
           outline-offset: 2px;
           border-radius: var(--radius-sm);
       }
   </style>
</head>
<body>
   <!-- כותרת אדמין -->
   <div class="container">
       <div class="admin-header">
           <h1>
               פאנל ניהול אדמין
           </h1>
           <p class="admin-subtitle">
               ניהול מלא של מערכת התורמים - גישה מתקדמת למנהלי המערכת
           </p>
           <div class="admin-controls">
               <div class="admin-welcome" id="adminWelcome">
                   שלום אדמין
               </div>
               <button class="dark-mode-toggle" onclick="toggleDarkMode()">
                   <span id="darkModeIcon">🌙</span>
                   <span id="darkModeText">מצב לילה</span>
               </button>
               <button class="btn btn-warning btn-sm" onclick="showSystemSettings()">
                   ⚙️ הגדרות מערכת
               </button>
               <button class="btn btn-info btn-sm" onclick="exportSystemData()">
                   💾 גיבוי מערכת
               </button>
               <button class="btn btn-danger" onclick="logout()">
                   🚪 התנתק
               </button>
           </div>
       </div>

       <!-- סטטיסטיקות ראשיות -->
       <div class="stats-grid">
           <div class="stat-card" onclick="showTab('donors')">
               <span class="stat-icon">👥</span>
               <span class="stat-number" id="totalDonors">0</span>
               <span class="stat-label">סה"כ תורמים</span>
               <div class="stat-change" id="donorsChange">+0 השבוע</div>
           </div>
           
           <div class="stat-card" onclick="showTab('users')">
               <span class="stat-icon">👤</span>
               <span class="stat-number" id="totalUsers">0</span>
               <span class="stat-label">משתמשי מערכת</span>
               <div class="stat-change" id="usersChange">+0 החודש</div>
           </div>
           
           <div class="stat-card" onclick="showTab('reports')">
               <span class="stat-icon">🔍</span>
               <span class="stat-number" id="totalSearches">0</span>
               <span class="stat-label">חיפושים היום</span>
               <div class="stat-change" id="searchesChange">+0% מאתמול</div>
           </div>
           
           <div class="stat-card" onclick="showTicketsOverview()">
               <span class="stat-icon">🎫</span>
               <span class="stat-number" id="openTickets">0</span>
               <span class="stat-label">כרטיסי תמיכה פתוחים</span>
               <div class="stat-change" id="ticketsChange">-0 מאתמול</div>
           </div>
           
           <div class="stat-card" onclick="showSystemHealth()">
               <span class="stat-icon">💾</span>
               <span class="stat-number" id="systemHealth">100%</span>
               <span class="stat-label">תקינות מערכת</span>
               <div class="stat-change">🟢 פעילה</div>
           </div>
           
           <div class="stat-card" onclick="showTab('reports')">
               <span class="stat-icon">📊</span>
               <span class="stat-number" id="dailyActivity">0</span>
               <span class="stat-label">פעילות יומית</span>
               <div class="stat-change">📈 ממוצע שבועי</div>
           </div>
       </div>

      <!-- ניווט ראשי -->
      <div class="admin-nav">
          <div class="nav-tab active" onclick="showTab('dashboard')">
              📊 לוח בקרה
          </div>
          <div class="nav-tab" onclick="showTab('donors')">
              👥 ניהול תורמים
          </div>
          <div class="nav-tab" onclick="showTab('users')">
              🔧 ניהול משתמשים
          </div>
          <div class="nav-tab" onclick="showTab('reports')">
              📈 דוחות וסטטיסטיקות
          </div>
          <div class="nav-tab" onclick="showTab('upload')">
              📄 העלאת קבצים
          </div>
          <div class="nav-tab" onclick="showTab('messages')">
              💬 ניהול הודעות
          </div>
          <div class="nav-tab" onclick="showTab('tickets')">
              🎫 כרטיסי תמיכה
          </div>
          <div class="nav-tab" onclick="showTab('logs')">
              📋 לוגי מערכת
          </div>
         <div class="nav-tab" onclick="showTab('donation-management')">
             💳 ניהול תרומות
         </div>
      </div>

      <!-- תוכן הלשוניות -->
      
      <!-- לוח בקרה -->
      <div id="dashboardTab" class="tab-content">
          <div class="charts-grid">
              <div class="chart-container">
                  <h3>📊 חיפושים יומיים - 7 ימים אחרונים</h3>
                  <canvas id="searchesChart" width="400" height="200"></canvas>
              </div>
              
              <div class="chart-container">
                  <h3>👥 פעילות משתמשים</h3>
                  <canvas id="usersChart" width="400" height="200"></canvas>
              </div>
          </div>
          
          <div class="card">
              <div class="card-header">
                  <h3 class="card-title">🕐 פעילות אחרונה</h3>
                  <button class="btn btn-info btn-sm" onclick="refreshActivity()">
                      🔄 רענן
                  </button>
              </div>
              <div id="recentActivity">
                  <div class="loading">
                      <div class="loading-spinner"></div>
                      טוען פעילות אחרונה...
                  </div>
              </div>
          </div>
      </div>

      <!-- ניהול תורמים -->
      <div id="donorsTab" class="tab-content hidden">
          <div class="card">
              <div class="card-header">
                  <h3 class="card-title">👥 ניהול תורמים</h3>
                  <div>
                      <button class="btn btn-success" onclick="showAddDonorModal()">
                          ➕ הוסף תורם חדש
                      </button>
                      <button class="btn btn-warning" onclick="showBulkEditModal()">
                          📝 עריכה קבוצתית
                      </button>
                      <button class="btn btn-info" onclick="exportDonors()">
                          📊 ייצא לאקסל
                      </button>
                  </div>
              </div>
              
              <!-- בקרות בחירה -->
              <div class="selection-controls" id="donorSelectionControls">
                  <div>
                      <span id="selectedCount">0</span> תורמים נבחרו
                  </div>
                  <div>
                      <button class="btn btn-sm" onclick="bulkEdit()">📝 עריכה קבוצתית</button>
                      <button class="btn btn-danger btn-sm" onclick="bulkDelete()">🗑️ מחיקה קבוצתית</button>
                      <button class="btn btn-secondary btn-sm" onclick="clearSelection()">❌ בטל בחירה</button>
                  </div>
              </div>
              
              <!-- סינונים וחיפוש -->
              <div class="search-filters">
                  <div class="form-group">
                      <label>🔍 חיפוש כללי:</label>
                      <input type="text" id="donorSearch" class="form-control" 
                             placeholder="חפש לפי שם, טלפון או אימייל..." 
                             oninput="filterDonors()">
                  </div>
                  <div class="form-group">
                      <label>🌆 עיר:</label>
                      <select id="cityFilter" class="form-control" onchange="filterDonors()">
                          <option value="">כל העיר</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label>🏷️ סוג תורם:</label>
                      <select id="typeFilter" class="form-control" onchange="filterDonors()">
                          <option value="">כל הסוגים</option>
                          <option value="VIP">VIP</option>
                          <option value="קבוע">קבוע</option>
                          <option value="רגיל">רגיל</option>
                          <option value="חדש">חדש</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label>📊 סטטוס:</label>
                      <select id="statusFilter" class="form-control" onchange="filterDonors()">
                          <option value="">כל הסטטוסים</option>
                          <option value="active">פעיל</option>
                          <option value="inactive">לא פעיל</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <button class="btn btn-secondary" onclick="clearFilters()" style="margin-top: 25px;">
                          🗑️ נקה סינונים
                      </button>
                  </div>
              </div>
              
              <!-- טבלת תורמים -->
              <div class="table-container">
                  <table class="table" id="donorsTable">
                      <thead>
                          <tr>
                              <th>
                                  <input type="checkbox" id="selectAllDonors" onchange="toggleSelectAll()">
                              </th>
                              <th onclick="sortTable('name')">👤 שם <span class="sort-indicator">⇅</span></th>
                              <th onclick="sortTable('phone')">📞 טלפון <span class="sort-indicator">⇅</span></th>
                              <th onclick="sortTable('email')">📧 אימייל <span class="sort-indicator">⇅</span></th>
                              <th onclick="sortTable('city')">🌆 עיר <span class="sort-indicator">⇅</span></th>
                              <th onclick="sortTable('donor_type')">🏷️ סוג <span class="sort-indicator">⇅</span></th>
                              <th onclick="sortTable('donation_amount')">💰 תרומה <span class="sort-indicator">⇅</span></th>
                              <th onclick="sortTable('created_at')">📅 נוצר <span class="sort-indicator">⇅</span></th>
                              <th>⚡ פעולות</th>
                          </tr>
                      </thead>
                      <tbody id="donorsTableBody">
                          <tr>
                              <td colspan="9" class="text-center">
                                  <div class="loading">
                                      <div class="loading-spinner"></div>
                                      טוען תורמים...
                                  </div>
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>
              
              <!-- עמודונים -->
              <div class="pagination" id="donorsPagination"></div>
          </div>
      </div>
	  <!-- ניהול משתמשים -->
      <div id="usersTab" class="tab-content hidden">
          <div class="card">
              <div class="card-header">
                  <h3 class="card-title">🔧 ניהול משתמשים</h3>
                  <button class="btn btn-success" onclick="showAddUserModal()">
                      ➕ הוסף משתמש חדש
                  </button>
              </div>
              
              <!-- סינון משתמשים -->
              <div class="search-filters">
                  <div class="form-group">
                      <label>🔍 חיפוש משתמש:</label>
                      <input type="text" id="userSearch" class="form-control" 
                             placeholder="חפש לפי שם משתמש או שם מלא..." 
                             oninput="filterUsers()">
                  </div>
                  <div class="form-group">
                      <label>👑 תפקיד:</label>
                      <select id="roleFilter" class="form-control" onchange="filterUsers()">
                          <option value="">כל התפקידים</option>
                          <option value="admin">אדמין</option>
                          <option value="operator">טלפן</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label>📊 סטטוס:</label>
                      <select id="userStatusFilter" class="form-control" onchange="filterUsers()">
                          <option value="">כל הסטטוסים</option>
                          <option value="1">פעיל</option>
                          <option value="0">לא פעיל</option>
                      </select>
                  </div>
              </div>
              
              <!-- טבלת משתמשים -->
              <div class="table-container">
                  <table class="table" id="usersTable">
                      <thead>
                          <tr>
                              <th>👤 שם משתמש</th>
                              <th>📛 שם מלא</th>
                              <th>📧 אימייל</th>
                              <th>📞 טלפון</th>
                              <th>🏢 מחלקה</th>
                              <th>👑 תפקיד</th>
                              <th>📊 סטטוס</th>
                              <th>🕐 התחברות אחרונה</th>
                              <th>📊 מספר חיפושים</th>
                              <th>⚡ פעולות</th>
                          </tr>
                      </thead>
                      <tbody id="usersTableBody">
                          <tr>
                              <td colspan="10" class="text-center">
                                  <div class="loading">
                                      <div class="loading-spinner"></div>
                                      טוען משתמשים...
                                  </div>
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>

      <!-- דוחות וסטטיסטיקות -->
      <div id="reportsTab" class="tab-content hidden">
          <div class="card">
              <div class="card-header">
                  <h3 class="card-title">📈 דוחות וסטטיסטיקות</h3>
                  <div>
                      <button class="btn btn-info" onclick="exportReports()">
                          📊 ייצא דוחות לאקסל
                      </button>
                      <button class="btn btn-success" onclick="generateReport()">
                          📋 צור דוח מותאם
                      </button>
                  </div>
              </div>
              
              <!-- בחירת תאריכים -->
              <div class="search-filters">
                  <div class="form-group">
                      <label>📅 מתאריך:</label>
                      <input type="date" id="fromDate" class="form-control" onchange="updateReports()">
                  </div>
                  <div class="form-group">
                      <label>📅 עד תאריך:</label>
                      <input type="date" id="toDate" class="form-control" onchange="updateReports()">
                  </div>
                  <div class="form-group">
                      <label>👤 משתמש:</label>
                      <select id="userReportFilter" class="form-control" onchange="updateReports()">
                          <option value="">כל המשתמשים</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <button class="btn btn-admin" onclick="loadReports()" style="margin-top: 25px;">
                          🔄 רענן דוחות
                      </button>
                  </div>
              </div>
              
              <!-- דוח חיפושים -->
              <div class="card">
                  <h4>🔍 דוח חיפושים</h4>
                  <div class="table-container">
                      <table class="table">
                          <thead>
                              <tr>
                                  <th>👤 משתמש</th>
                                  <th>📅 תאריך</th>
                                  <th>🔍 סה"כ חיפושים</th>
                                  <th>🎯 חיפושים ייחודיים</th>
                                  <th>📊 ממוצע תוצאות</th>
                                  <th>⏰ שעות פעילות</th>
                              </tr>
                          </thead>
                          <tbody id="searchReportBody">
                              <tr>
                                  <td colspan="6" class="text-center">
                                      <div class="loading">
                                          <div class="loading-spinner"></div>
                                          טוען דוח חיפושים...
                                      </div>
                                  </td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
              </div>
              
              <!-- דפוסי עבודה -->
              <div class="card">
                  <h4>⏰ דפוסי עבודה של טלפנים</h4>
                  <div class="charts-grid">
                      <div class="chart-container">
                          <h5>📊 פעילות לפי שעות</h5>
                          <canvas id="workPatternsChart" width="400" height="200"></canvas>
                      </div>
                      <div class="chart-container">
                          <h5>📈 פעילות לפי ימים</h5>
                          <canvas id="dailyActivityChart" width="400" height="200"></canvas>
                      </div>
                  </div>
              </div>
          </div>
      </div>

<!-- העלאת קבצים -->
<div id="uploadTab" class="tab-content hidden">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">📄 העלאת קבצים</h3>
            <div>
                <button class="btn btn-info" onclick="downloadTemplate()">
                    📋 הורד תבנית CSV
                </button>
                <button class="btn btn-warning" onclick="showDataQuality()">
                    🔍 בדיקת איכות נתונים
                </button>
            </div>
        </div>
        
        <div id="uploadMessage"></div>
        
        <!-- אזור העלאה -->
        <div class="upload-area" id="uploadArea" 
             ondrop="handleDrop(event)" 
             ondragover="handleDragOver(event)"
             ondragleave="handleDragLeave(event)">
            <div style="font-size: 48px; margin-bottom: 20px;">📁</div>
            <h3>גרור קובץ CSV לכאן או לחץ לבחירה</h3>
            <p style="margin: 15px 0; color: #666;">
                תומך בקבצי CSV עד 50MB
            </p>
            <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileSelect(this)">
            <button class="btn btn-admin btn-lg" onclick="document.getElementById('csvFile').click()">
                📁 בחר קובץ CSV
            </button>
        </div>
        
        <!-- פרטי הקובץ -->
        <div id="fileDetails" class="hidden">
            <div class="card">
                <h4>📋 פרטי הקובץ</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>📁 שם הקובץ:</label>
                        <input type="text" id="fileName" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>📊 גודל:</label>
                        <input type="text" id="fileSize" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>📝 סוג:</label>
                        <input type="text" id="fileType" class="form-control" readonly>
                    </div>
                </div>
                
                <!-- אפשרויות העלאה -->
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="replaceData" checked>
                            החלף את כל הנתונים הקיימים
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="skipDuplicates" checked>
                            דלג על כפילויות
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="validateData" checked>
                            בדוק איכות נתונים
                        </label>
                    </div>
                </div>
                
                <!-- כפתורי פעולה -->
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success btn-lg" onclick="uploadCSV()">
                        🚀 העלה קובץ
                    </button>
                    <button class="btn btn-secondary" onclick="cancelUpload()">
                        ❌ בטל
                    </button>
                </div>
                
                <!-- התקדמות -->
                <div id="uploadProgress" class="hidden">
                    <h5>📊 התקדמות העלאה:</h5>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p id="progressText">0%</p>
                </div>
            </div>
        </div>
        
        <!-- כרטיס סינכרון Airtable -->
        <div class="card">
            <h3>🔄 סינכרון נתונים</h3>
            <p>עדכון מידע תורמים מ-Airtable</p>
            <button class="btn btn-primary" onclick="manualAirtableSync()" id="syncButton">
                🔄 עדכן תורמים מ-Airtable עכשיו
            </button>
            <div id="syncStatus" style="margin-top: 15px;"></div>
        </div>
        
        <!-- היסטוריית העלאות -->
        <div class="card">
            <h4>📚 היסטוריית העלאות</h4>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>📅 תאריך</th>
                            <th>📁 שם קובץ</th>
                            <th>👤 הועלה על ידי</th>
                            <th>📊 רשומות</th>
                            <th>⚠️ כפילויות</th>
                            <th>❌ שגיאות</th>
                            <th>📊 סטטוס</th>
                        </tr>
                    </thead>
                    <tbody id="uploadHistoryBody">
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    טוען היסטוריה...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

      <!-- ניהול הודעות -->
      <div id="messagesTab" class="tab-content hidden">
          <div class="card">
              <div class="card-header">
                  <h3 class="card-title">💬 ניהול הודעות מערכת</h3>
                  <button class="btn btn-success" onclick="showCreateMessageModal()">
                      ➕ צור הודעה חדשה
                  </button>
              </div>
              
              <!-- רשימת הודעות -->
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>📋 כותרת</th>
                              <th>📝 תוכן</th>
                              <th>🏷️ סוג</th>
                              <th>🎯 יעד</th>
                              <th>⚡ עדיפות</th>
                              <th>📅 נוצר</th>
                              <th>⏰ פוקע</th>
                              <th>📊 סטטוס</th>
                              <th>⚡ פעולות</th>
                          </tr>
                      </thead>
                      <tbody id="messagesTableBody">
                          <tr>
                              <td colspan="9" class="text-center">
                                  <div class="loading">
                                      <div class="loading-spinner"></div>
                                      טוען הודעות...
                                  </div>
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>

      <!-- כרטיסי תמיכה -->
      <div id="ticketsTab" class="tab-content hidden">
          <div class="card">
              <div class="card-header">
                  <h3 class="card-title">🎫 ניהול כרטיסי תמיכה</h3>
                  <div>
                      <span class="badge badge-warning" id="pendingTickets">0 ממתינים</span>
                      <span class="badge badge-info" id="inProgressTickets">0 בטיפול</span>
                  </div>
              </div>
              
              <!-- סינון כרטיסים -->
              <div class="search-filters">
                  <div class="form-group">
                      <label>📊 סטטוס:</label>
                      <select id="ticketStatusFilter" class="form-control" onchange="filterTickets()">
                          <option value="">כל הסטטוסים</option>
                          <option value="open">פתוח</option>
                          <option value="in_progress">בטיפול</option>
                          <option value="resolved">נפתר</option>
                          <option value="closed">סגור</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label>📂 קטגוריה:</label>
                      <select id="ticketCategoryFilter" class="form-control" onchange="filterTickets()">
                          <option value="">כל הקטגוריות</option>
                          <option value="technical">טכני</option>
                          <option value="data">נתונים</option>
                          <option value="access">גישה</option>
                          <option value="training">הדרכה</option>
                          <option value="other">אחר</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label>⚡ עדיפות:</label>
                      <select id="ticketPriorityFilter" class="form-control" onchange="filterTickets()">
                          <option value="">כל העדיפויות</option>
                          <option value="urgent">דחוף</option>
                          <option value="high">גבוהה</option>
                          <option value="medium">בינונית</option>
                          <option value="low">נמוכה</option>
                      </select>
                  </div>
              </div>
              
              <!-- טבלת כרטיסים -->
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>🎫 מספר</th>
                              <th>📋 כותרת</th>
                              <th>👤 פותח</th>
                              <th>📂 קטגוריה</th>
                              <th>⚡ עדיפות</th>
                              <th>📊 סטטוס</th>
                              <th>👨‍💼 מטפל</th>
                              <th>📅 נוצר</th>
                              <th>🔄 עודכן</th>
                              <th>⚡ פעולות</th>
                          </tr>
                      </thead>
                      <tbody id="ticketsTableBody">
                          <tr>
                              <td colspan="10" class="text-center">
                                  <div class="loading">
                                      <div class="loading-spinner"></div>
                                      טוען כרטיסים...
                                  </div>
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>

      <!-- לוגי מערכת -->
      <div id="logsTab" class="tab-content hidden">
          <div class="card">
              <div class="card-header">
                  <h3 class="card-title">📋 לוגי מערכת</h3>
                  <div>
                      <button class="btn btn-warning" onclick="clearOldLogs()">
                          🗑️ נקה לוגים ישנים
                      </button>
                      <button class="btn btn-info" onclick="exportLogs()">
                          📊 ייצא לוגים
                      </button>
                  </div>
              </div>
              
              <!-- סינון לוגים -->
              <div class="search-filters">
                  <div class="form-group">
                      <label>👤 משתמש:</label>
                      <select id="logUserFilter" class="form-control" onchange="filterLogs()">
                          <option value="">כל המשתמשים</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label>⚡ פעולה:</label>
                      <select id="logActionFilter" class="form-control" onchange="filterLogs()">
                          <option value="">כל הפעולות</option>
                          <option value="LOGIN">התחברות</option>
                          <option value="SEARCH">חיפוש</option>
                          <option value="CREATE_DONOR">יצירת תורם</option>
                          <option value="UPDATE_DONOR">עדכון תורם</option>
                          <option value="DELETE_DONOR">מחיקת תורם</option>
                          <option value="CSV_UPLOAD">העלאת CSV</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label>📅 מתאריך:</label>
                      <input type="date" id="logFromDate" class="form-control" onchange="filterLogs()">
                  </div>
                  <div class="form-group">
                      <label>📅 עד תאריך:</label>
                      <input type="date" id="logToDate" class="form-control" onchange="filterLogs()">
                  </div>
              </div>
              
              <!-- טבלת לוגים -->
              <div class="table-container">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>🕐 זמן</th>
                              <th>👤 משתמש</th>
                              <th>⚡ פעולה</th>
                              <th>🎯 יעד</th>
                              <th>📝 פרטים</th>
                              <th>🌐 IP</th>
                              <th>🖥️ דפדפן</th>
                          </tr>
                      </thead>
                      <tbody id="logsTableBody">
                          <tr>
                              <td colspan="7" class="text-center">
                                  <div class="loading">
                                      <div class="loading-spinner"></div>
                                      טוען לוגים...
                                  </div>
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>
              
              <!-- עמודונים -->
              <div class="pagination" id="logsPagination"></div>
          </div>
      </div>
  </div>

     <!-- ניהול תרומות -->
     <div id="donation-managementTab" class="tab-content hidden">
         <div class="card">
             <div class="card-header">
                 <h3 class="card-title">💳 ניהול סוגי תרומות</h3>
                 <div>
                     <button class="btn btn-success" onclick="showAddDonationTypeModal()">
                         ➕ הוסף סוג תרומה חדש
                     </button>
                     <button class="btn btn-info" onclick="showDonationStats()">
                         📊 סטטיסטיקות שימוש
                     </button>
                     <button class="btn btn-warning" onclick="showDonationLogs()">
                         📋 לוגי גישה
                     </button>
                 </div>
             </div>
             
             <!-- טבלת סוגי תרומות -->
             <div class="table-container">
                 <table class="table" id="donationTypesTable">
                     <thead>
                         <tr>
                             <th>📝 שם התרומה</th>
                             <th>🔗 קישור</th>
                             <th>📅 תאריך התחלה</th>
                             <th>📅 תאריך סיום</th>
                             <th>📊 סטטוס</th>
                             <th>👤 נוצר על ידי</th>
                             <th>📅 נוצר</th>
                             <th>⚡ פעולות</th>
                         </tr>
                     </thead>
                     <tbody id="donationTypesTableBody">
                         <tr>
                             <td colspan="8" class="text-center">
                                 <div class="loading">
                                     <div class="loading-spinner"></div>
                                     טוען סוגי תרומות...
                                 </div>
                             </td>
                         </tr>
                     </tbody>
                 </table>
             </div>
         </div>
     </div>
 </div>

  <!-- מודלים -->
  
  <!-- מודל הוספת תורם -->
  <div id="addDonorModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>➕ הוספת תורם חדש</h3>
              <button class="modal-close" onclick="closeModal('addDonorModal')">&times;</button>
          </div>
          <form id="addDonorForm">
              <div class="form-row">
                  <div class="form-group">
                      <label>👤 שם מלא: *</label>
                      <input type="text" id="donorName" class="form-control" required>
                  </div>
                  <div class="form-group">
                      <label>📞 טלפון: *</label>
                      <input type="tel" id="donorPhone" class="form-control" required>
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>📧 אימייל:</label>
                      <input type="email" id="donorEmail" class="form-control">
                  </div>
                  <div class="form-group">
                      <label>🌆 עיר:</label>
                      <input type="text" id="donorCity" class="form-control">
                  </div>
              </div>
              <div class="form-group">
                  <label>🏠 כתובת מלאה:</label>
                  <input type="text" id="donorAddress" class="form-control">
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>💰 סכום תרומה:</label>
                      <input type="number" id="donorAmount" class="form-control" min="0" step="0.01">
                  </div>
                  <div class="form-group">
                      <label>🏷️ סוג תורם:</label>
                      <select id="donorType" class="form-control">
                          <option value="רגיל">רגיל</option>
                          <option value="קבוע">קבוע</option>
                          <option value="VIP">VIP</option>
                          <option value="חדש">חדש</option>
                      </select>
                  </div>
              </div>
              <div class="form-group">
                  <label>📝 הערות:</label>
                  <textarea id="donorNotes" class="form-control" rows="3"></textarea>
              </div>
              <div style="text-align: center; margin-top: 25px;">
                  <button type="submit" class="btn btn-success btn-lg">💾 שמור תורם</button>
                  <button type="button" class="btn btn-secondary" onclick="closeModal('addDonorModal')">❌ בטל</button>
              </div>
          </form>
      </div>
  </div>

  <!-- מודל עריכת תורם -->
  <div id="editDonorModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>✏️ עריכת תורם</h3>
              <button class="modal-close" onclick="closeModal('editDonorModal')">&times;</button>
          </div>
          <form id="editDonorForm">
              <input type="hidden" id="editDonorId">
              <div class="form-row">
                  <div class="form-group">
                      <label>👤 שם מלא: *</label>
                      <input type="text" id="editDonorName" class="form-control" required>
                  </div>
                  <div class="form-group">
                      <label>📞 טלפון: *</label>
                      <input type="tel" id="editDonorPhone" class="form-control" required>
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>📧 אימייל:</label>
                      <input type="email" id="editDonorEmail" class="form-control">
                  </div>
                  <div class="form-group">
                      <label>🌆 עיר:</label>
                      <input type="text" id="editDonorCity" class="form-control">
                  </div>
              </div>
              <div class="form-group">
                  <label>🏠 כתובת מלאה:</label>
                  <input type="text" id="editDonorAddress" class="form-control">
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>💰 סכום תרומה:</label>
                      <input type="number" id="editDonorAmount" class="form-control" min="0" step="0.01">
                  </div>
                  <div class="form-group">
                      <label>🏷️ סוג תורם:</label>
                      <select id="editDonorType" class="form-control">
                          <option value="רגיל">רגיל</option>
                          <option value="קבוע">קבוע</option>
                          <option value="VIP">VIP</option>
                          <option value="חדש">חדש</option>
                      </select>
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>📊 סטטוס:</label>
                      <select id="editDonorStatus" class="form-control">
                          <option value="active">פעיל</option>
                          <option value="inactive">לא פעיל</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label>📅 תאריך יצירה:</label>
                      <input type="text" id="editDonorCreated" class="form-control" readonly>
                  </div>
              </div>
              <div class="form-group">
                  <label>📝 הערות:</label>
                  <textarea id="editDonorNotes" class="form-control" rows="3"></textarea>
              </div>
              <div style="text-align: center; margin-top: 25px;">
                  <button type="submit" class="btn btn-success btn-lg">💾 שמור שינויים</button>
                  <button type="button" class="btn btn-secondary" onclick="closeModal('editDonorModal')">❌ בטל</button>
                  <button type="button" class="btn btn-danger" onclick="deleteDonor()">🗑️ מחק תורם</button>
              </div>
          </form>
      </div>
  </div>

  <!-- מודל הוספת משתמש -->
  <div id="addUserModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>👤 הוספת משתמש חדש</h3>
              <button class="modal-close" onclick="closeModal('addUserModal')">&times;</button>
          </div>
          <form id="addUserForm">
              <div class="form-row">
                  <div class="form-group">
                      <label>👤 שם משתמש: *</label>
                      <input type="text" id="newUsername" class="form-control" required 
                             placeholder="אותיות אנגליות ומספרים בלבד">
                  </div>
                  <div class="form-group">
                      <label>📛 שם מלא: *</label>
                      <input type="text" id="newUserFullName" class="form-control" required 
                             placeholder="שם פרטי ושם משפחה">
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>🔒 סיסמה: *</label>
                      <input type="password" id="newUserPassword" class="form-control" required 
                             minlength="6" placeholder="לפחות 6 תווים">
                  </div>
                  <div class="form-group">
                      <label>🔒 אימות סיסמה: *</label>
                      <input type="password" id="confirmUserPassword" class="form-control" required 
                             placeholder="הכנס שוב את הסיסמה">
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>📧 אימייל:</label>
                      <input type="email" id="newUserEmail" class="form-control" 
                             placeholder="user@example.com">
                  </div>
                  <div class="form-group">
				  <label>📞 טלפון:</label>
                      <input type="tel" id="newUserPhone" class="form-control" 
                             placeholder="050-1234567">
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>🏢 מחלקה:</label>
                      <input type="text" id="newUserDepartment" class="form-control" 
                             placeholder="מוקד טלפוני">
                  </div>
                  <div class="form-group">
                      <label>👑 תפקיד: *</label>
                      <select id="newUserRole" class="form-control" required>
                          <option value="operator">טלפן רגיל</option>
                          <option value="admin">אדמין</option>
                      </select>
                  </div>
              </div>
              <div class="form-group">
                  <label>📝 הערות:</label>
                  <textarea id="newUserNotes" class="form-control" rows="2" 
                            placeholder="הערות על המשתמש (אופציונלי)"></textarea>
              </div>
              <div style="text-align: center; margin-top: 25px;">
                  <button type="submit" class="btn btn-success btn-lg">👤 צור משתמש</button>
                  <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">❌ בטל</button>
              </div>
          </form>
      </div>
  </div>

  <!-- מודל עריכת משתמש -->
  <div id="editUserModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>✏️ עריכת משתמש</h3>
              <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
          </div>
          <form id="editUserForm">
              <input type="hidden" id="editUserId">
              <div class="form-row">
                  <div class="form-group">
                      <label>👤 שם משתמש: *</label>
                      <input type="text" id="editUsername" class="form-control" required readonly 
                             style="background: #f0f0f0;">
                      <small class="text-muted">לא ניתן לשנות שם משתמש</small>
                  </div>
                  <div class="form-group">
                      <label>📛 שם מלא: *</label>
                      <input type="text" id="editUserFullName" class="form-control" required>
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>📧 אימייל:</label>
                      <input type="email" id="editUserEmail" class="form-control">
                  </div>
                  <div class="form-group">
                      <label>📞 טלפון:</label>
                      <input type="tel" id="editUserPhone" class="form-control">
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>🏢 מחלקה:</label>
                      <input type="text" id="editUserDepartment" class="form-control">
                  </div>
                  <div class="form-group">
                      <label>👑 תפקיד: *</label>
                      <select id="editUserRole" class="form-control" required>
                          <option value="operator">טלפן רגיל</option>
                          <option value="admin">אדמין</option>
                      </select>
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>📊 סטטוס:</label>
                      <select id="editUserStatus" class="form-control">
                          <option value="1">פעיל</option>
                          <option value="0">לא פעיל</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label>🕐 התחברות אחרונה:</label>
                      <input type="text" id="editUserLastLogin" class="form-control" readonly>
                  </div>
              </div>
              <div class="form-group">
                  <label>🔒 סיסמה חדשה:</label>
                  <input type="password" id="editUserPassword" class="form-control" 
                         placeholder="השאר ריק אם לא רוצה לשנות">
                  <small class="text-muted">השאר ריק כדי לא לשנות את הסיסמה</small>
              </div>
              <div class="form-group">
                  <label>📝 הערות:</label>
                  <textarea id="editUserNotes" class="form-control" rows="2"></textarea>
              </div>
              <div style="text-align: center; margin-top: 25px;">
                  <button type="submit" class="btn btn-success btn-lg">💾 שמור שינויים</button>
                  <button type="button" class="btn btn-warning" onclick="resetUserPassword()">🔒 איפוס סיסמה</button>
                  <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">❌ בטל</button>
              </div>
          </form>
      </div>
  </div>

  <!-- מודל יצירת הודעה -->
  <div id="createMessageModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>💬 יצירת הודעה חדשה</h3>
              <button class="modal-close" onclick="closeModal('createMessageModal')">&times;</button>
          </div>
          <form id="createMessageForm">
              <div class="form-group">
                  <label>📋 כותרת ההודעה: *</label>
                  <input type="text" id="messageTitle" class="form-control" required 
                         placeholder="כותרת קצרה ומובנת">
              </div>
              <div class="form-group">
                  <label>📝 תוכן ההודעה: *</label>
                  <textarea id="messageContent" class="form-control" rows="4" required 
                            placeholder="תוכן מפורט של ההודעה..."></textarea>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>🏷️ סוג הודעה:</label>
                      <select id="messageType" class="form-control">
                          <option value="info">מידע כללי</option>
                          <option value="success">הודעת הצלחה</option>
                          <option value="warning">אזהרה</option>
                          <option value="error">שגיאה חשובה</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label>⚡ עדיפות:</label>
                      <select id="messagePriority" class="form-control">
                          <option value="1">רגילה</option>
                          <option value="2">חשובה</option>
                          <option value="3">קריטית</option>
                      </select>
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>🎯 יעד:</label>
                      <select id="messageTarget" class="form-control" onchange="toggleTargetUser()">
                          <option value="all">כל המשתמשים</option>
                          <option value="operator">טלפנים בלבד</option>
                          <option value="admin">אדמינים בלבד</option>
                          <option value="specific">משתמש ספציפי</option>
                      </select>
                  </div>
                  <div class="form-group" id="specificUserGroup" style="display: none;">
                      <label>👤 משתמש ספציפי:</label>
                      <select id="targetUserId" class="form-control">
                          <option value="">בחר משתמש...</option>
                      </select>
                  </div>
              </div>
              <div class="form-group">
                  <label>⏰ תאריך פקיעה (אופציונלי):</label>
                  <input type="datetime-local" id="messageExpires" class="form-control">
                  <small class="text-muted">השאר ריק אם ההודעה לא פוקעת</small>
              </div>
              <div style="text-align: center; margin-top: 25px;">
                  <button type="submit" class="btn btn-success btn-lg">📨 שלח הודעה</button>
                  <button type="button" class="btn btn-secondary" onclick="closeModal('createMessageModal')">❌ בטל</button>
              </div>
          </form>
      </div>
  </div>

  <!-- מודל פרטי כרטיס תמיכה -->
  <div id="ticketDetailsModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>🎫 פרטי כרטיס תמיכה</h3>
              <button class="modal-close" onclick="closeModal('ticketDetailsModal')">&times;</button>
          </div>
          <div id="ticketDetailsContent">
              <div class="loading">
                  <div class="loading-spinner"></div>
                  טוען פרטי כרטיס...
              </div>
          </div>
      </div>
  </div>

  <!-- מודל עריכה קבוצתית -->
  <div id="bulkEditModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>📝 עריכה קבוצתית</h3>
              <button class="modal-close" onclick="closeModal('bulkEditModal')">&times;</button>
          </div>
          <div class="message info">
              <span>📊</span>
              <span id="bulkEditCount">0 תורמים נבחרו לעריכה</span>
          </div>
          <form id="bulkEditForm">
              <div class="form-group">
                  <label>
                      <input type="checkbox" id="bulkEditCity"> 
                      🌆 עדכן עיר לכל הנבחרים:
                  </label>
                  <input type="text" id="bulkCityValue" class="form-control" disabled>
              </div>
              <div class="form-group">
                  <label>
                      <input type="checkbox" id="bulkEditType"> 
                      🏷️ עדכן סוג תורם לכל הנבחרים:
                  </label>
                  <select id="bulkTypeValue" class="form-control" disabled>
                      <option value="רגיל">רגיל</option>
                      <option value="קבוע">קבוע</option>
                      <option value="VIP">VIP</option>
                      <option value="חדש">חדש</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>
                      <input type="checkbox" id="bulkEditStatus"> 
                      📊 עדכן סטטוס לכל הנבחרים:
                  </label>
                  <select id="bulkStatusValue" class="form-control" disabled>
                      <option value="active">פעיל</option>
                      <option value="inactive">לא פעיל</option>
                  </select>
              </div>
              <div style="text-align: center; margin-top: 25px;">
                  <button type="submit" class="btn btn-success btn-lg">💾 בצע עדכון קבוצתי</button>
                  <button type="button" class="btn btn-secondary" onclick="closeModal('bulkEditModal')">❌ בטל</button>
              </div>
          </form>
      </div>
  </div>

 <!-- מודל הוספת סוג תרומה -->
 <div id="addDonationTypeModal" class="modal">
     <div class="modal-content">
         <div class="modal-header">
             <h3>➕ הוספת סוג תרומה חדש</h3>
             <button class="modal-close" onclick="closeModal('addDonationTypeModal')">&times;</button>
         </div>
         <form id="addDonationTypeForm">
             <div class="form-group">
                 <label>📝 שם התרומה: *</label>
                 <input type="text" id="donationTypeName" class="form-control" required 
                        placeholder="לדוגמה: תיקון נפטרים, הכנסת ספר תורה">
             </div>
             
             <div class="form-group">
                 <label>🔗 קישור דף החיוב: *</label>
                 <input type="url" id="donationTypeUrl" class="form-control" required 
                        placeholder="https://example.com/donation-page">
                 <small class="text-muted">הכנס קישור מלא לדף החיוב</small>
             </div>
             
             <div class="form-group">
                 <label>📝 תיאור (אופציונלי):</label>
                 <textarea id="donationTypeDescription" class="form-control" rows="3" 
                           placeholder="תיאור קצר על התרומה..."></textarea>
             </div>
             
             <div class="form-row">
                 <div class="form-group">
                     <label>📅 תאריך התחלה:</label>
                     <input type="date" id="donationTypeStartDate" class="form-control">
                 </div>
                 <div class="form-group">
                     <label>📅 תאריך סיום:</label>
                     <input type="date" id="donationTypeEndDate" class="form-control">
                 </div>
             </div>
             
             <div class="form-group">
                 <label>
                     <input type="checkbox" id="donationTypeNoExpiry"> 
                     ♾️ ללא תאריך פקיעה (תמיד פעיל)
                 </label>
             </div>
             
             <div style="text-align: center; margin-top: 25px;">
                 <button type="submit" class="btn btn-success btn-lg">💾 צור סוג תרומה</button>
                 <button type="button" class="btn btn-secondary" onclick="closeModal('addDonationTypeModal')">❌ בטל</button>
             </div>
         </form>
     </div>
 </div>

 <!-- מודל עריכת סוג תרומה -->
 <div id="editDonationTypeModal" class="modal">
     <div class="modal-content">
         <div class="modal-header">
             <h3>✏️ עריכת סוג תרומה</h3>
             <button class="modal-close" onclick="closeModal('editDonationTypeModal')">&times;</button>
         </div>
         <form id="editDonationTypeForm">
             <input type="hidden" id="editDonationTypeId">
             
             <div class="form-group">
                 <label>📝 שם התרומה: *</label>
                 <input type="text" id="editDonationTypeName" class="form-control" required>
             </div>
             
             <div class="form-group">
                 <label>🔗 קישור דף החיוב: *</label>
                 <input type="url" id="editDonationTypeUrl" class="form-control" required>
             </div>
             
             <div class="form-group">
                 <label>📝 תיאור:</label>
                 <textarea id="editDonationTypeDescription" class="form-control" rows="3"></textarea>
             </div>
             
             <div class="form-row">
                 <div class="form-group">
                     <label>📅 תאריך התחלה:</label>
                     <input type="date" id="editDonationTypeStartDate" class="form-control">
                 </div>
                 <div class="form-group">
                     <label>📅 תאריך סיום:</label>
                     <input type="date" id="editDonationTypeEndDate" class="form-control">
                 </div>
             </div>
             
             <div class="form-row">
                 <div class="form-group">
                     <label>
                         <input type="checkbox" id="editDonationTypeNoExpiry"> 
                         ♾️ ללא תאריך פקיעה
                     </label>
                 </div>
                 <div class="form-group">
                     <label>
                         <input type="checkbox" id="editDonationTypeIsActive"> 
                         ✅ פעיל במערכת
                     </label>
                 </div>
             </div>
             
             <div style="text-align: center; margin-top: 25px;">
                 <button type="submit" class="btn btn-success btn-lg">💾 שמור שינויים</button>
                 <button type="button" class="btn btn-danger" onclick="deleteDonationType()">🗑️ מחק סוג תרומה</button>
                 <button type="button" class="btn btn-secondary" onclick="closeModal('editDonationTypeModal')">❌ בטל</button>
             </div>
         </form>
     </div>
 </div>

 <!-- מודל סטטיסטיקות -->
 <div id="donationStatsModal" class="modal">
     <div class="modal-content">
         <div class="modal-header">
             <h3>📊 סטטיסטיקות שימוש בתרומות</h3>
             <button class="modal-close" onclick="closeModal('donationStatsModal')">&times;</button>
         </div>
         <div>
             <div class="search-filters">
                 <div class="form-group">
                     <label>📅 מתאריך:</label>
                     <input type="date" id="statsFromDate" class="form-control" onchange="loadDonationStats()">
                 </div>
                 <div class="form-group">
                     <label>📅 עד תאריך:</label>
                     <input type="date" id="statsToDate" class="form-control" onchange="loadDonationStats()">
                 </div>
                 <div class="form-group">
                     <button class="btn btn-admin" onclick="loadDonationStats()" style="margin-top: 25px;">
                         🔄 רענן סטטיסטיקות
                     </button>
                 </div>
             </div>
             
             <div class="table-container">
                 <table class="table">
                     <thead>
                         <tr>
                             <th>💳 שם התרומה</th>
                             <th>👁️ צפיות</th>
                             <th>👤 משתמשים ייחודיים</th>
                             <th>📅 גישה אחרונה</th>
                             <th>🏆 המשתמש הפעיל ביותר</th>
                         </tr>
                     </thead>
                     <tbody id="donationStatsBody">
                         <tr>
                             <td colspan="5" class="text-center">
                                 <div class="loading">
                                     <div class="loading-spinner"></div>
                                     טוען סטטיסטיקות...
                                 </div>
                             </td>
                         </tr>
                     </tbody>
                 </table>
             </div>
         </div>
     </div>
 </div>

 <!-- מודל לוגי גישה -->
 <div id="donationLogsModal" class="modal">
     <div class="modal-content">
         <div class="modal-header">
             <h3>📋 לוגי גישה לתרומות</h3>
             <button class="modal-close" onclick="closeModal('donationLogsModal')">&times;</button>
         </div>
         <div>
             <div class="table-container">
                 <table class="table">
                     <thead>
                         <tr>
                             <th>📅 זמן</th>
                             <th>👤 משתמש</th>
                             <th>💳 סוג תרומה</th>
                             <th>⚡ פעולה</th>
                             <th>🌐 IP</th>
                         </tr>
                     </thead>
                     <tbody id="donationLogsBody">
                         <tr>
                             <td colspan="5" class="text-center">
                                 <div class="loading">
                                     <div class="loading-spinner"></div>
                                     טוען לוגים...
                                 </div>
                             </td>
                         </tr>
                     </tbody>
                 </table>
             </div>
         </div>
     </div>
 </div>

  <script>
      // משתני גלובליים
      let currentUser = null;
      let authToken = null;
      let allDonors = [];
      let filteredDonors = [];
      let allUsers = [];
      let selectedDonors = new Set();
      let currentPage = 1;
      let itemsPerPage = 50;
      let sortColumn = '';
      let sortDirection = 'asc';

      // טעינת הדף
      window.onload = function() {
          console.log('👑 פאנל אדמין נטען');
          checkAuthentication();
          
          // בדיקת מצב לילה
          if (localStorage.getItem('darkMode') === 'true') {
              document.body.classList.add('dark-mode');
              updateDarkModeButton();
          }
      };

      // בדיקת הזדהות
      function checkAuthentication() {
          const token = localStorage.getItem('authToken');
          const user = localStorage.getItem('currentUser');
          
          if (!token || !user) {
              console.log('❌ לא מזוהה - מפנה לדף התחברות');
              window.location.href = 'login.html';
              return;
          }
          
          try {
              currentUser = JSON.parse(user);
              authToken = token;
              
              // בדיקה שהמשתמש הוא אדמין
              if (currentUser.role !== 'admin') {
                  console.log('🔄 לא אדמין - מפנה לממשק טלפן');
                  window.location.href = 'index.html';
                  return;
              }
              
              console.log('✅ אדמין מזוהה:', currentUser.username);
              initializeAdminPanel();
              
          } catch (error) {
              console.error('❌ שגיאה בפענוח נתוני משתמש:', error);
              logout();
          }
      }

      // אתחול פאנל האדמין
      function initializeAdminPanel() {
          // עדכון ברכה
          const welcomeEl = document.getElementById('adminWelcome');
          const fullName = currentUser.full_name || currentUser.username;
          welcomeEl.textContent = `שלום ${fullName} `;
          
          // טעינת נתונים ראשוניים
          loadDashboardData();
          
          // הוספת event listeners
          setupEventListeners();
          
          console.log('✅ פאנל אדמין הוכן בהצלחה');
      }

// פונקציות טיפול בטפסים - צריכות להיות מוגדרות לפני setupEventListeners
async function handleAddDonationType(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('donationTypeName').value.trim(),
        url: document.getElementById('donationTypeUrl').value.trim(),
        description: document.getElementById('donationTypeDescription').value.trim(),
        start_date: document.getElementById('donationTypeStartDate').value || null,
        end_date: document.getElementById('donationTypeEndDate').value || null,
        no_expiry: document.getElementById('donationTypeNoExpiry').checked
    };
    
    if (!formData.name || !formData.url) {
        showNotification('שם ו-URL נדרשים', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/donation-types', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('סוג תרומה נוצר בהצלחה! 💳', 'success');
            closeModal('addDonationTypeModal');
            document.getElementById('addDonationTypeForm').reset();
            loadDonationTypesAdmin();
        } else {
            showNotification(data.error || 'שגיאה ביצירת סוג תרומה', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

async function handleEditDonationType(e) {
    e.preventDefault();
    
    const id = document.getElementById('editDonationTypeId').value;
    const formData = {
        name: document.getElementById('editDonationTypeName').value.trim(),
        url: document.getElementById('editDonationTypeUrl').value.trim(),
        description: document.getElementById('editDonationTypeDescription').value.trim(),
        start_date: document.getElementById('editDonationTypeStartDate').value || null,
        end_date: document.getElementById('editDonationTypeEndDate').value || null,
        no_expiry: document.getElementById('editDonationTypeNoExpiry').checked,
        is_active: document.getElementById('editDonationTypeIsActive').checked
    };
    
    if (!formData.name || !formData.url) {
        showNotification('שם ו-URL נדרשים', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/donation-types/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('סוג תרומה עודכן בהצלחה! ✏️', 'success');
            closeModal('editDonationTypeModal');
            loadDonationTypesAdmin();
        } else {
            showNotification(data.error || 'שגיאה בעדכון סוג תרומה', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// פונקציות טיפול בטפסים אחרים - זמניות
async function handleAddDonor(e) { e.preventDefault(); console.log('הוספת תורם'); }
async function handleEditDonor(e) { e.preventDefault(); console.log('עריכת תורם'); }
async function handleAddUser(e) { e.preventDefault(); console.log('הוספת משתמש'); }
async function handleEditUser(e) { e.preventDefault(); console.log('עריכת משתמש'); }
async function handleCreateMessage(e) { e.preventDefault(); console.log('יצירת הודעה'); }
async function handleBulkEdit(e) { e.preventDefault(); console.log('עריכה קבוצתית'); }

// הגדרת מאזיני אירועים
function setupEventListeners() {
    // checkbox עריכה קבוצתית
    document.getElementById('bulkEditCity').addEventListener('change', function(e) {
        document.getElementById('bulkCityValue').disabled = !e.target.checked;
    });
    
    document.getElementById('bulkEditType').addEventListener('change', function(e) {
        document.getElementById('bulkTypeValue').disabled = !e.target.checked;
    });
    
    document.getElementById('bulkEditStatus').addEventListener('change', function(e) {
        document.getElementById('bulkStatusValue').disabled = !e.target.checked;
    });

    // טפסים - בדיקה שהאלמנטים קיימים לפני החיבור
    const addDonorForm = document.getElementById('addDonorForm');
    const editDonorForm = document.getElementById('editDonorForm');
    const addUserForm = document.getElementById('addUserForm');
    const editUserForm = document.getElementById('editUserForm');
    const createMessageForm = document.getElementById('createMessageForm');
    const bulkEditForm = document.getElementById('bulkEditForm');
    
    if (addDonorForm) addDonorForm.addEventListener('submit', handleAddDonor);
    if (editDonorForm) editDonorForm.addEventListener('submit', handleEditDonor);
    if (addUserForm) addUserForm.addEventListener('submit', handleAddUser);
    if (editUserForm) editUserForm.addEventListener('submit', handleEditUser);
    if (createMessageForm) createMessageForm.addEventListener('submit', handleCreateMessage);
    if (bulkEditForm) bulkEditForm.addEventListener('submit', handleBulkEdit);

    // drag & drop לקבצים
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
        uploadArea.addEventListener('dragenter', handleDragEnter);
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
    }

    // הגדרות חדשות לניהול תרומות - יתחברו רק אם הטפסים קיימים
    const addDonationForm = document.getElementById('addDonationTypeForm');
    const editDonationForm = document.getElementById('editDonationTypeForm');
    
    if (addDonationForm) {
        addDonationForm.addEventListener('submit', handleAddDonationType);
    }
    if (editDonationForm) {
        editDonationForm.addEventListener('submit', handleEditDonationType);
    }
    
    // checkbox עבור תאריכי תרומות
    const noExpiryCheckbox = document.getElementById('donationTypeNoExpiry');
    if (noExpiryCheckbox) {
        noExpiryCheckbox.addEventListener('change', function(e) {
            const startDate = document.getElementById('donationTypeStartDate');
            const endDate = document.getElementById('donationTypeEndDate');
            
            if (startDate && endDate) {
                if (e.target.checked) {
                    startDate.disabled = true;
                    endDate.disabled = true;
                    startDate.value = '';
                    endDate.value = '';
                } else {
                    startDate.disabled = false;
                    endDate.disabled = false;
                }
            }
        });
    }

    const editNoExpiryCheckbox = document.getElementById('editDonationTypeNoExpiry');
    if (editNoExpiryCheckbox) {
        editNoExpiryCheckbox.addEventListener('change', function(e) {
            const startDate = document.getElementById('editDonationTypeStartDate');
            const endDate = document.getElementById('editDonationTypeEndDate');
            
            if (startDate && endDate) {
                if (e.target.checked) {
                    startDate.disabled = true;
                    endDate.disabled = true;
                    startDate.value = '';
                    endDate.value = '';
                } else {
                    startDate.disabled = false;
                    endDate.disabled = false;
                }
            }
        });
    }
}

      // מצב לילה
      function toggleDarkMode() {
          document.body.classList.toggle('dark-mode');
          const isDark = document.body.classList.contains('dark-mode');
          localStorage.setItem('darkMode', isDark);
          updateDarkModeButton();
      }

      function updateDarkModeButton() {
          const isDark = document.body.classList.contains('dark-mode');
          document.getElementById('darkModeIcon').textContent = isDark ? '☀️' : '🌙';
          document.getElementById('darkModeText').textContent = isDark ? 'מצב יום' : 'מצב לילה';
      }

// החלף את הפונקציה showTab הקיימת עם הגרסה המתוקנת הזו:
function showTab(tabName) {
    console.log('🔄 מעבר לטאב:', tabName); // לדיבוג
    
    // הסרת active מכל הלשוניות
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // הסתרת כל התוכן
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // הצגת הלשונית הנבחרת
    const activeTab = document.querySelector(`[onclick="showTab('${tabName}')"]`);
    if (activeTab) {
        activeTab.classList.add('active');
    }
    
    const tabContent = document.getElementById(`${tabName}Tab`);
    if (tabContent) {
        tabContent.classList.remove('hidden');
    } else {
        console.error('❌ לא נמצא תוכן עבור טאב:', tabName);
    }
    
    // טעינת נתונים ספציפיים ללשונית
    switch(tabName) {
        case 'dashboard':
            loadDashboardData();
            break;
        case 'donors':
            loadDonors();
            break;
        case 'users':
            loadUsers();
            break;
        case 'reports':
            loadReports();
            break;
        case 'upload':
            loadUploadHistory();
            break;
        case 'messages':
            loadMessages();
            break;
        case 'tickets':
            loadTickets();
            break;
        case 'logs':
            loadLogs();
            break;
        case 'donation-management':
            loadDonationTypesAdmin();
            break;
        default:
            console.warn('⚠️ טאב לא מוכר:', tabName);
    }
}

      // טעינת נתוני לוח הבקרה
      async function loadDashboardData() {
          try {
              const response = await fetch('/api/admin/dashboard', {
                  headers: { 'Authorization': `Bearer ${authToken}` }
              });
              
              if (response.ok) {
                  const data = await response.json();
                  updateDashboardStats(data);
                  loadRecentActivity();
              }
          } catch (error) {
              console.error('❌ שגיאה בטעינת לוח בקרה:', error);
          }
      }

      function updateDashboardStats(data) {
          document.getElementById('totalDonors').textContent = data.totalDonors || 0;
          document.getElementById('totalUsers').textContent = data.totalUsers || 0;
          document.getElementById('totalSearches').textContent = data.totalSearches || 0;
          document.getElementById('openTickets').textContent = data.openTickets || 0;
          document.getElementById('dailyActivity').textContent = data.dailyActivity || 0;
          
          // עדכון שינויים
          document.getElementById('donorsChange').textContent = `+${data.donorsChange || 0} השבוע`;
          document.getElementById('usersChange').textContent = `+${data.usersChange || 0} החודש`;
          document.getElementById('searchesChange').textContent = `+${data.searchesChange || 0}% מאתמול`;
          document.getElementById('ticketsChange').textContent = `-${data.ticketsChange || 0} מאתמול`;
      }

      // טעינת פעילות אחרונה
      async function loadRecentActivity() {
          try {
              const response = await fetch('/api/admin/recent-activity', {
                  headers: { 'Authorization': `Bearer ${authToken}` }
              });
              
              if (response.ok) {
                  const activities = await response.json();
                  displayRecentActivity(activities);
              }
          } catch (error) {
              console.error('❌ שגיאה בטעינת פעילות:', error);
              document.getElementById('recentActivity').innerHTML = 
                  '<div class="empty-state"><div class="empty-state-icon">⚠️</div><h3>שגיאה בטעינת נתונים</h3></div>';
          }
      }

      function displayRecentActivity(activities) {
          const container = document.getElementById('recentActivity');
          
          if (activities.length === 0) {
              container.innerHTML = `
                  <div class="empty-state">
                      <div class="empty-state-icon">📊</div>
                      <h3>אין פעילות אחרונה</h3>
                      <p>פעילויות המערכת יופיעו כאן</p>
                  </div>
              `;
              return;
          }
          
          container.innerHTML = activities.map(activity => `
              <div class="message ${getActivityType(activity.action)}" style="margin-bottom: 10px;">
                  <div>
                      <strong>${activity.username || 'משתמש לא ידוע'}</strong>
                      <span>${getActivityText(activity.action)}</span>
                      ${activity.details ? `<span class="text-muted">- ${activity.details}</span>` : ''}
                      <br>
                      <small class="text-muted">
                          🕐 ${new Date(activity.created_at).toLocaleString('he-IL')}
                          ${activity.ip_address ? `| 🌐 ${activity.ip_address}` : ''}
                      </small>
                  </div>
              </div>
          `).join('');
      }

function getActivityType(action) {
          const typeMap = {
              'LOGIN': 'info',
              'SEARCH': 'info',
              'CREATE_DONOR': 'success',
              'UPDATE_DONOR': 'warning',
              'DELETE_DONOR': 'error',
              'CSV_UPLOAD': 'success',
              'CREATE_USER': 'success',
              'UPDATE_USER': 'warning'
          };
          return typeMap[action] || 'info';
      }

      function getActivityText(action) {
          const textMap = {
              'LOGIN': 'התחבר למערכת',
              'SEARCH': 'ביצע חיפוש',
              'CREATE_DONOR': 'יצר תורם חדש',
              'UPDATE_DONOR': 'עדכן תורם',
              'DELETE_DONOR': 'מחק תורם',
              'CSV_UPLOAD': 'העלה קובץ CSV',
              'CREATE_USER': 'יצר משתמש חדש',
              'UPDATE_USER': 'עדכן משתמש'
          };
          return textMap[action] || action;
      }

      // טעינת תורמים
async function loadDonors() {
    try {
        showLoading('donorsTableBody');
        
        const response = await fetch('/api/admin/donors?page=1&limit=1000', {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            allDonors = data.donors || [];
            filteredDonors = [...allDonors];
            displayDonors();
            populateFilterOptions();
        } else {
            throw new Error('שגיאה בטעינת תורמים');
        }
    } catch (error) {
        console.error('❌ שגיאה בטעינת תורמים:', error);
        document.getElementById('donorsTableBody').innerHTML = 
            '<tr><td colspan="9" class="text-center">שגיאה בטעינת נתונים</td></tr>';
    }
}

function displayDonors() {
    const tbody = document.getElementById('donorsTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    
    if (filteredDonors.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center">
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <h3>אין תורמים להצגה</h3>
						                       <p>נסה לשנות את הסינונים או להוסיף תורמים חדשים</p>
                   </div>
               </td>
           </tr>
       `;
       return;
   }
   
   const paginatedDonors = filteredDonors.slice(startIndex, endIndex);
   
   tbody.innerHTML = paginatedDonors.map(donor => `
       <tr ${selectedDonors.has(donor.id) ? 'class="selected"' : ''}>
           <td>
               <input type="checkbox" 
                      ${selectedDonors.has(donor.id) ? 'checked' : ''}
                      onchange="toggleDonorSelection(${donor.id})">
           </td>
           <td>
               <strong>${donor.name || ''}</strong>
               ${donor.donations_count > 1 ? `
                   <br><small class="text-muted">${donor.donations_count} תרומות</small>
               ` : ''}
           </td>
           <td>${donor.phone || ''}</td>
           <td>${donor.email || ''}</td>
           <td>${donor.city || ''}</td>
           <td>
               ${donor.total_amount ? `
                   <span class="badge badge-success">₪${donor.total_amount.toLocaleString()}</span>
               ` : ''}
           </td>
           <td>
               <span class="badge ${donor.donations_count > 1 ? 'badge-warning' : 'badge-info'}">
                   ${donor.donations_count > 1 ? 'תורם חוזר' : 'תרומה יחידה'}
               </span>
           </td>
           <td>${new Date(donor.created_at).toLocaleDateString('he-IL')}</td>
           <td>
               <button class="btn btn-info btn-sm" onclick="editDonor(${donor.id})" title="עריכה">
                   ✏️
               </button>
               <button class="btn btn-danger btn-sm" onclick="confirmDeleteDonor(${donor.id})" title="מחיקה">
                   🗑️
               </button>
               ${donor.donations_count > 1 ? `
                   <button class="btn btn-success btn-sm" onclick="viewDonorDetails(${donor.id})" title="פרטים מלאים">
                       📊
                   </button>
               ` : ''}
           </td>
       </tr>
   `).join('');
   
   updatePagination('donorsPagination', filteredDonors.length);
   updateSelectionControls();
}

async function viewDonorDetails(donorId) {
   try {
       // קבלת כל התרומות של התורם
       const response = await fetch(`/api/admin/donor/${donorId}/all-donations`, {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (response.ok) {
           const donations = await response.json();
           displayDonorDetailsModal(donations);
       } else {
           showNotification('שגיאה בטעינת פרטי תורם', 'error');
       }
   } catch (error) {
       showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

function displayDonorDetailsModal(donations) {
   if (donations.length === 0) {
       showNotification('לא נמצאו תרומות לתורם זה', 'warning');
       return;
   }
   
   const firstDonation = donations[0];
   const totalAmount = donations.reduce((sum, d) => {
       const amount = d.payment_amount ? 
           parseFloat(d.payment_amount.replace('₪', '').replace(/,/g, '')) || 0 : 
           d.donation_amount || 0;
       return sum + amount;
   }, 0);
   
   const modal = document.createElement('div');
   modal.className = 'modal show';
   modal.innerHTML = `
       <div class="modal-content" style="max-width: 1000px;">
           <div class="modal-header">
               <h3>👤 פרטי תורם מלאים</h3>
               <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
           </div>
           <div>
               <div class="card">
                   <h4>${firstDonation.name || (firstDonation.first_name + ' ' + firstDonation.last_name)}</h4>
                   
                   <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                       <div><strong>📞 טלפון:</strong> ${firstDonation.phone || ''}</div>
                       <div><strong>📧 אימייל:</strong> ${firstDonation.email || ''}</div>
                       <div><strong>🌆 עיר:</strong> ${firstDonation.city || ''}</div>
                       <div><strong>🏠 רחוב:</strong> ${firstDonation.street || ''}</div>
                       <div><strong>🏢 בניין:</strong> ${firstDonation.building || ''}</div>
                       <div><strong>🚪 דירה:</strong> ${firstDonation.apartment || ''}</div>
                       <div><strong>💰 סה"כ תרם:</strong> ₪${totalAmount.toLocaleString()}</div>
                       <div><strong>🎯 מספר תרומות:</strong> ${donations.length}</div>
                   </div>
                   
                   <div style="margin-top: 25px;">
                       <h4>💰 היסטוריית תרומות:</h4>
                       <div style="max-height: 500px; overflow-y: auto;">
                           ${donations.map((donation, index) => `
                               <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0;">
                                   <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                       <h5>תרומה #${index + 1} ${donation.order_number ? `(הזמנה: ${donation.order_number})` : ''}</h5>
                                       <span class="badge badge-success">${donation.payment_status || 'לא ידוע'}</span>
                                   </div>
                                   
                                   <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                       ${donation.project_name ? `<div><strong>📋 פרויקט:</strong> ${donation.project_name}</div>` : ''}
                                       ${donation.prayer_name ? `<div><strong>🙏 שם לתפילה:</strong> ${donation.prayer_name}</div>` : ''}
                                       ${donation.payment_amount ? `<div><strong>💰 סכום:</strong> ${donation.payment_amount} ש"ח</div>` : ''}
                                       ${donation.payment_method ? `<div><strong>💳 תשלום:</strong> ${donation.payment_method}</div>` : ''}
                                       ${donation.delivery_date ? `<div><strong>📅 מסירה:</strong> ${donation.delivery_date}</div>` : ''}
                                       ${donation.marketing_source ? `<div><strong>📢 מקור:</strong> ${donation.marketing_source}</div>` : ''}
                                   </div>
                                   
                                   ${donation.comments ? `
                                       <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                                           <strong>💬 הערות:</strong> ${donation.comments}
                                       </div>
                                   ` : ''}
                                   
                                   <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                       📅 ${new Date(donation.created_at).toLocaleDateString('he-IL')} ${new Date(donation.created_at).toLocaleTimeString('he-IL')}
                                   </div>
                               </div>
                           `).join('')}
                       </div>
                   </div>
                   
                   <div style="text-align: center; margin-top: 25px;">
                       <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                           ❌ סגור
                       </button>
                   </div>
               </div>
           </div>
       </div>
   `;
   document.body.appendChild(modal);
}

// פונקציה לייצוא נתוני תורם ספציפי
function exportDonorData(donorId) {
    // מימוש ייצוא נתוני התורם
    showNotification('מייצא נתוני תורם...', 'info');
}

      function getDonorTypeBadge(type) {
          const badgeMap = {
              'VIP': 'badge-warning',
              'קבוע': 'badge-success',
              'רגיל': 'badge-info',
              'חדש': 'badge-secondary'
          };
          return badgeMap[type] || 'badge-info';
      }

      function populateFilterOptions() {
          // מילוי סינון ערים
          const cities = [...new Set(allDonors.map(d => d.city).filter(c => c))].sort();
          const cityFilter = document.getElementById('cityFilter');
          cityFilter.innerHTML = '<option value="">כל הערים</option>' +
              cities.map(city => `<option value="${city}">${city}</option>`).join('');
      }

      // סינון תורמים
      function filterDonors() {
          const searchTerm = document.getElementById('donorSearch').value.toLowerCase();
          const cityFilter = document.getElementById('cityFilter').value;
          const typeFilter = document.getElementById('typeFilter').value;
          const statusFilter = document.getElementById('statusFilter').value;
          
          filteredDonors = allDonors.filter(donor => {
              const matchesSearch = !searchTerm || 
                  (donor.name && donor.name.toLowerCase().includes(searchTerm)) ||
                  (donor.phone && donor.phone.includes(searchTerm)) ||
                  (donor.email && donor.email.toLowerCase().includes(searchTerm));
              
              const matchesCity = !cityFilter || donor.city === cityFilter;
              const matchesType = !typeFilter || donor.donor_type === typeFilter;
              const matchesStatus = !statusFilter || donor.status === statusFilter;
              
              return matchesSearch && matchesCity && matchesType && matchesStatus;
          });
          
          currentPage = 1;
          displayDonors();
      }

      function clearFilters() {
          document.getElementById('donorSearch').value = '';
          document.getElementById('cityFilter').value = '';
          document.getElementById('typeFilter').value = '';
          document.getElementById('statusFilter').value = '';
          filteredDonors = [...allDonors];
          currentPage = 1;
          displayDonors();
      }

      // בחירת תורמים
      function toggleDonorSelection(donorId) {
          if (selectedDonors.has(donorId)) {
              selectedDonors.delete(donorId);
          } else {
              selectedDonors.add(donorId);
          }
          updateSelectionControls();
          displayDonors();
      }

      function toggleSelectAll() {
          const checkbox = document.getElementById('selectAllDonors');
          const currentPageDonors = filteredDonors.slice(
              (currentPage - 1) * itemsPerPage,
              currentPage * itemsPerPage
          );
          
          if (checkbox.checked) {
              currentPageDonors.forEach(donor => selectedDonors.add(donor.id));
          } else {
              currentPageDonors.forEach(donor => selectedDonors.delete(donor.id));
          }
          
          updateSelectionControls();
          displayDonors();
      }

      function updateSelectionControls() {
          const count = selectedDonors.size;
          const controls = document.getElementById('donorSelectionControls');
          const countEl = document.getElementById('selectedCount');
          
          if (count > 0) {
              controls.classList.add('show');
              countEl.textContent = count;
			  } else {
              controls.classList.remove('show');
          }
      }

      function clearSelection() {
          selectedDonors.clear();
          updateSelectionControls();
          displayDonors();
          document.getElementById('selectAllDonors').checked = false;
      }

      // מיון טבלה
      function sortTable(column) {
          if (sortColumn === column) {
              sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
              sortColumn = column;
              sortDirection = 'asc';
          }
          
          filteredDonors.sort((a, b) => {
              let aVal = a[column] || '';
              let bVal = b[column] || '';
              
              if (column === 'donation_amount') {
                  aVal = parseFloat(aVal) || 0;
                  bVal = parseFloat(bVal) || 0;
              } else if (column === 'created_at') {
                  aVal = new Date(aVal);
                  bVal = new Date(bVal);
              } else {
                  aVal = aVal.toString().toLowerCase();
                  bVal = bVal.toString().toLowerCase();
              }
              
              if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
              if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
              return 0;
          });
          
          displayDonors();
          updateSortIndicators();
      }

      function updateSortIndicators() {
          document.querySelectorAll('.sort-indicator').forEach(indicator => {
              indicator.textContent = '⇅';
          });
          
          if (sortColumn) {
              const header = document.querySelector(`th[onclick="sortTable('${sortColumn}')"] .sort-indicator`);
              if (header) {
                  header.textContent = sortDirection === 'asc' ? '↑' : '↓';
              }
          }
      }

      // עמודונים
      function updatePagination(containerId, totalItems) {
          const container = document.getElementById(containerId);
          const totalPages = Math.ceil(totalItems / itemsPerPage);
          
          if (totalPages <= 1) {
              container.innerHTML = '';
              return;
          }
          
          let html = '';
          
          // כפתור הקודם
          html += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>« הקודם</button>`;
          
          // מספרי עמודים
          for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
              html += `<button onclick="changePage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
          }
          
          // כפתור הבא
          html += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>הבא »</button>`;
          
          container.innerHTML = html;
      }

      function changePage(page) {
          currentPage = page;
          displayDonors();
      }

      // טעינת משתמשים
      async function loadUsers() {
          try {
              showLoading('usersTableBody');
              
              const response = await fetch('/api/admin/users', {
                  headers: { 'Authorization': `Bearer ${authToken}` }
              });
              
              if (response.ok) {
                  allUsers = await response.json();
                  displayUsers();
                  populateUserSelects();
              } else {
                  throw new Error('שגיאה בטעינת משתמשים');
              }
          } catch (error) {
              console.error('❌ שגיאה בטעינת משתמשים:', error);
              document.getElementById('usersTableBody').innerHTML = 
                  '<tr><td colspan="10" class="text-center">שגיאה בטעינת נתונים</td></tr>';
          }
      }

      function displayUsers() {
          const tbody = document.getElementById('usersTableBody');
          
          if (allUsers.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="10" class="text-center">
                          <div class="empty-state">
                              <div class="empty-state-icon">👤</div>
                              <h3>אין משתמשים במערכת</h3>
                              <p>צור משתמש ראשון כדי להתחיל</p>
                          </div>
                      </td>
                  </tr>
              `;
              return;
          }
          
          tbody.innerHTML = allUsers.map(user => `
              <tr>
                  <td><strong>${user.username}</strong></td>
                  <td>${user.full_name || ''}</td>
                  <td>${user.email || ''}</td>
                  <td>${user.phone || ''}</td>
                  <td>${user.department || ''}</td>
                  <td>
                      <span class="badge ${user.role === 'admin' ? 'badge-danger' : 'badge-info'}">
                          ${user.role === 'admin' ? 'אדמין' : 'טלפן'}
                      </span>
                  </td>
                  <td>
                      <span class="badge ${user.is_active ? 'badge-success' : 'badge-secondary'}">
                          ${user.is_active ? 'פעיל' : 'לא פעיל'}
                      </span>
                  </td>
                  <td>${user.last_login ? new Date(user.last_login).toLocaleString('he-IL') : 'אף פעם'}</td>
                  <td>${user.login_count || 0}</td>
                  <td>
                      <button class="btn btn-info btn-sm" onclick="editUser(${user.id})" title="עריכה">
                          ✏️
                      </button>
                      <button class="btn btn-warning btn-sm" onclick="resetUserPassword(${user.id})" title="איפוס סיסמה">
                          🔒
                      </button>
                      <button class="btn btn-success btn-sm" onclick="viewUserLogs(${user.id})" title="לוגים">
                          📋
                      </button>
                      ${user.username !== currentUser.username ? `
                          <button class="btn btn-danger btn-sm" onclick="confirmDeleteUser(${user.id})" title="מחיקה">
                              🗑️
                          </button>
                      ` : ''}
                  </td>
              </tr>
          `).join('');
      }

      function populateUserSelects() {
          // עדכון רשימת משתמשים בסלקטים שונים
          const userSelect = document.getElementById('targetUserId');
          const reportUserSelect = document.getElementById('userReportFilter');
          const logUserSelect = document.getElementById('logUserFilter');
          
          const options = allUsers.map(user => 
              `<option value="${user.id}">${user.full_name || user.username}</option>`
          ).join('');
          
          if (userSelect) {
              userSelect.innerHTML = '<option value="">בחר משתמש...</option>' + options;
          }
          if (reportUserSelect) {
              reportUserSelect.innerHTML = '<option value="">כל המשתמשים</option>' + options;
          }
          if (logUserSelect) {
              logUserSelect.innerHTML = '<option value="">כל המשתמשים</option>' + options;
          }
      }

      // סינון משתמשים
      function filterUsers() {
          const searchTerm = document.getElementById('userSearch').value.toLowerCase();
          const roleFilter = document.getElementById('roleFilter').value;
          const statusFilter = document.getElementById('userStatusFilter').value;
          
          let filteredUsers = allUsers.filter(user => {
              const matchesSearch = !searchTerm || 
                  (user.username && user.username.toLowerCase().includes(searchTerm)) ||
                  (user.full_name && user.full_name.toLowerCase().includes(searchTerm));
              
              const matchesRole = !roleFilter || user.role === roleFilter;
              const matchesStatus = statusFilter === '' || user.is_active.toString() === statusFilter;
              
              return matchesSearch && matchesRole && matchesStatus;
          });
          
          // עדכון תצוגה עם משתמשים מסוננים
          const tbody = document.getElementById('usersTableBody');
          tbody.innerHTML = filteredUsers.map(user => `
              <tr>
                  <td><strong>${user.username}</strong></td>
                  <td>${user.full_name || ''}</td>
                  <td>${user.email || ''}</td>
                  <td>${user.phone || ''}</td>
                  <td>${user.department || ''}</td>
                  <td>
                      <span class="badge ${user.role === 'admin' ? 'badge-danger' : 'badge-info'}">
                          ${user.role === 'admin' ? 'אדמין' : 'טלפן'}
                      </span>
                  </td>
                  <td>
                      <span class="badge ${user.is_active ? 'badge-success' : 'badge-secondary'}">
                          ${user.is_active ? 'פעיל' : 'לא פעיל'}
                      </span>
                  </td>
                  <td>${user.last_login ? new Date(user.last_login).toLocaleString('he-IL') : 'אף פעם'}</td>
                  <td>${user.login_count || 0}</td>
                  <td>
                      <button class="btn btn-info btn-sm" onclick="editUser(${user.id})" title="עריכה">
                          ✏️
                      </button>
                      <button class="btn btn-warning btn-sm" onclick="resetUserPassword(${user.id})" title="איפוס סיסמה">
                          🔒
                      </button>
                      <button class="btn btn-success btn-sm" onclick="viewUserLogs(${user.id})" title="לוגים">
                          📋
                      </button>
                      ${user.username !== currentUser.username ? `
                          <button class="btn btn-danger btn-sm" onclick="confirmDeleteUser(${user.id})" title="מחיקה">
                              🗑️
                          </button>
                      ` : ''}
                  </td>
              </tr>
          `).join('');
      }

      // הצגת loading
      function showLoading(elementId) {
          document.getElementById(elementId).innerHTML = `
              <tr>
                  <td colspan="10" class="text-center">
                      <div class="loading">
                          <div class="loading-spinner"></div>
                          טוען נתונים...
                      </div>
                  </td>
              </tr>
          `;
      }

      // מודלים
      function openModal(modalId) {
          document.getElementById(modalId).classList.add('show');
          document.body.style.overflow = 'hidden';
      }

      function closeModal(modalId) {
          document.getElementById(modalId).classList.remove('show');
          document.body.style.overflow = 'auto';
      }

      // הצגת הודעות
      function showNotification(message, type = 'info', duration = 4000) {
          const notification = document.createElement('div');
          notification.className = `notification-toast message ${type}`;
          notification.style.cssText = `
              position: fixed;
              top: 20px;
              left: 50%;
              transform: translateX(-50%);
              z-index: 9999;
              min-width: 350px;
              max-width: 600px;
              text-align: center;
              box-shadow: 0 8px 32px rgba(0,0,0,0.3);
              animation: slideDown 0.3s ease;
          `;
          
          notification.innerHTML = `
              <div style="display: flex; align-items: center; justify-content: space-between;">
                  <span>${message}</span>
                  <button onclick="this.parentElement.parentElement.remove()" 
                          style="background: none; border: none; color: inherit; cursor: pointer; font-size: 20px; margin-right: 15px;">
                      ×
                  </button>
              </div>
          `;
          
          document.body.appendChild(notification);
          
          setTimeout(() => {
              if (notification.parentNode) {
                  notification.style.animation = 'slideUp 0.3s ease';
                  setTimeout(() => notification.remove(), 300);
              }
          }, duration);
      }

      // התנתקות
      function logout() {
          if (confirm('האם אתה בטוח שברצונך להתנתק מפאנל האדמין?')) {
              console.log('👋 אדמין מתנתק...');
              localStorage.removeItem('authToken');
              localStorage.removeItem('currentUser');
              window.location.href = 'login.html';
          }
      }

      // פונקציות שיושלמו בהמשך...
      function showAddDonorModal() { openModal('addDonorModal'); }
      function showAddUserModal() { openModal('addUserModal'); }
      function showCreateMessageModal() { openModal('createMessageModal'); }
      function showBulkEditModal() { 
          if (selectedDonors.size === 0) {
              showNotification('אנא בחר תורמים לעריכה קבוצתית', 'warning');
              return;
          }
          document.getElementById('bulkEditCount').textContent = `${selectedDonors.size} תורמים נבחרו לעריכה`;
          openModal('bulkEditModal'); 
      }

      function loadReports() { console.log('טוען דוחות...'); }
      function loadUploadHistory() { console.log('טוען היסטוריית העלאות...'); }
      function loadMessages() { console.log('טוען הודעות...'); }
      function loadTickets() { console.log('טוען כרטיסים...'); }
      function loadLogs() { console.log('טוען לוגים...'); }

      // אירועי drag & drop
      function handleDragEnter(e) { e.preventDefault(); }
      function handleDragOver(e) { 
          e.preventDefault(); 
          e.currentTarget.classList.add('dragover');
      }
      function handleDragLeave(e) { 
          e.currentTarget.classList.remove('dragover'); 
      }
      function handleDrop(e) { 
          e.preventDefault(); 
          e.currentTarget.classList.remove('dragover');
          console.log('קובץ נגרר:', e.dataTransfer.files[0]);
      }

      // טפסים - יושלמו בהמשך
      function handleAddDonor(e) { e.preventDefault(); console.log('הוספת תורם'); }
      function handleEditDonor(e) { e.preventDefault(); console.log('עריכת תורם'); }
      function handleAddUser(e) { e.preventDefault(); console.log('הוספת משתמש'); }
      function handleEditUser(e) { e.preventDefault(); console.log('עריכת משתמש'); }
      function handleCreateMessage(e) { e.preventDefault(); console.log('יצירת הודעה'); }
      function handleBulkEdit(e) { e.preventDefault(); console.log('עריכה קבוצתית'); }

      console.log('✅ פאנל אדמין הוכן במלואו!');


// === פונקציות ניהול תורמים ===

     // טעינת סוגי תרומות (אדמין)
     async function loadDonationTypesAdmin() {
         try {
             showLoading('donationTypesTableBody');
             
             const response = await fetch('/api/admin/donation-types', {
                 headers: { 'Authorization': `Bearer ${authToken}` }
             });
             
             if (response.ok) {
                 const donationTypes = await response.json();
                 allDonationTypes = donationTypes;
                 displayDonationTypesAdmin(donationTypes);
             } else {
                 throw new Error('שגיאה בטעינת סוגי תרומות');
             }
         } catch (error) {
             console.error('❌ שגיאה בטעינת תרומות:', error);
             document.getElementById('donationTypesTableBody').innerHTML = 
                 '<tr><td colspan="8" class="text-center">שגיאה בטעינת נתונים</td></tr>';
         }
     }

     // הצגת סוגי תרומות בטבלה
     function displayDonationTypesAdmin(donationTypes) {
         const tbody = document.getElementById('donationTypesTableBody');
         
         if (donationTypes.length === 0) {
             tbody.innerHTML = `
                 <tr>
                     <td colspan="8" class="text-center">
                         <div class="empty-state">
                             <div class="empty-state-icon">💳</div>
                             <h3>אין סוגי תרומות במערכת</h3>
                             <p>צור סוג תרומה ראשון</p>
                         </div>
                     </td>
                 </tr>
             `;
             return;
         }
         
         tbody.innerHTML = donationTypes.map(donation => `
             <tr>
                 <td><strong>${donation.name}</strong></td>
                 <td>
                     <a href="${donation.url}" target="_blank" title="פתח קישור">
                         🔗 ${donation.url.length > 30 ? donation.url.substring(0, 30) + '...' : donation.url}
                     </a>
                 </td>
                 <td>${donation.start_date ? new Date(donation.start_date).toLocaleDateString('he-IL') : 'ללא הגבלה'}</td>
                 <td>${donation.end_date ? new Date(donation.end_date).toLocaleDateString('he-IL') : 'ללא הגבלה'}</td>
                 <td>
                     <span class="badge ${donation.is_active ? 'badge-success' : 'badge-secondary'}">
                         ${donation.is_active ? '✅ פעיל' : '❌ לא פעיל'}
                     </span>
                     ${donation.no_expiry ? '<span class="badge badge-info">♾️ ללא פקיעה</span>' : ''}
                 </td>
                 <td>${donation.created_by_name || donation.created_by_username || 'לא ידוע'}</td>
                 <td>${new Date(donation.created_at).toLocaleDateString('he-IL')}</td>
                 <td>
                     <button class="btn btn-info btn-sm" onclick="editDonationType(${donation.id})" title="עריכה">
                         ✏️
                     </button>
                     <button class="btn btn-warning btn-sm" onclick="testDonationPage('${donation.url}')" title="בדוק דף">
                         🔍
                     </button>
                     <button class="btn btn-danger btn-sm" onclick="confirmDeleteDonationType(${donation.id})" title="מחיקה">
                         🗑️
                     </button>
                 </td>
             </tr>
         `).join('');
     }

     // הצגת מודל הוספה
     function showAddDonationTypeModal() {
         openModal('addDonationTypeModal');
         document.getElementById('donationTypeName').focus();
     }

     // עריכת סוג תרומה
     function editDonationType(id) {
         // מצא את סוג התרומה
         const donationType = allDonationTypes?.find(d => d.id === id);
         if (!donationType) {
             showNotification('סוג תרומה לא נמצא', 'error');
             return;
         }
         
         // מילוי הטופס
         document.getElementById('editDonationTypeId').value = donationType.id;
         document.getElementById('editDonationTypeName').value = donationType.name || '';
         document.getElementById('editDonationTypeUrl').value = donationType.url || '';
         document.getElementById('editDonationTypeDescription').value = donationType.description || '';
         document.getElementById('editDonationTypeStartDate').value = donationType.start_date || '';
         document.getElementById('editDonationTypeEndDate').value = donationType.end_date || '';
         document.getElementById('editDonationTypeNoExpiry').checked = donationType.no_expiry || false;
         document.getElementById('editDonationTypeIsActive').checked = donationType.is_active || false;
         
         openModal('editDonationTypeModal');
     }

     // בדיקת דף תרומה
     function testDonationPage(url) {
         window.open(url, '_blank', 'width=800,height=600');
         showNotification('דף התרומה נפתח בחלון חדש', 'info');
     }

     // מחיקת סוג תרומה
     function confirmDeleteDonationType(id) {
         if (confirm('האם אתה בטוח שברצונך למחוק את סוג התרומה? פעולה זו לא ניתנת לביטול!')) {
             deleteDonationTypeById(id);
         }
     }

     async function deleteDonationTypeById(id) {
         try {
             const response = await fetch(`/api/admin/donation-types/${id}`, {
                 method: 'DELETE',
                 headers: { 'Authorization': `Bearer ${authToken}` }
             });
             
             const data = await response.json();
             
             if (response.ok) {
                 showNotification(data.message || 'סוג תרומה נמחק בהצלחה', 'success');
                 loadDonationTypesAdmin();
             } else {
                 showNotification(data.error || 'שגיאה במחיקת סוג תרומה', 'error');
             }
         } catch (error) {
             showNotification('שגיאת תקשורת עם השרת', 'error');
         }
     }

     // סטטיסטיקות
     function showDonationStats() {
         openModal('donationStatsModal');
         loadDonationStats();
     }

     async function loadDonationStats() {
         try {
             const fromDate = document.getElementById('statsFromDate').value;
             const toDate = document.getElementById('statsToDate').value;
             
             const params = new URLSearchParams();
             if (fromDate) params.append('from_date', fromDate);
             if (toDate) params.append('to_date', toDate);
             
             const response = await fetch(`/api/admin/donation-types/stats?${params.toString()}`, {
                 headers: { 'Authorization': `Bearer ${authToken}` }
             });
             
             if (response.ok) {
                 const stats = await response.json();
                 displayDonationStats(stats);
             } else {
                 throw new Error('שגיאה בטעינת סטטיסטיקות');
             }
         } catch (error) {
             console.error('❌ שגיאה בסטטיסטיקות:', error);
             document.getElementById('donationStatsBody').innerHTML = 
                 '<tr><td colspan="5" class="text-center">שגיאה בטעינת נתונים</td></tr>';
         }
     }

     function displayDonationStats(stats) {
         const tbody = document.getElementById('donationStatsBody');
         
         if (stats.length === 0) {
             tbody.innerHTML = `
                 <tr>
                     <td colspan="5" class="text-center">
                         <div class="empty-state">
                             <div class="empty-state-icon">📊</div>
                             <h3>אין נתוני שימוש</h3>
                         </div>
                     </td>
                 </tr>
             `;
             return;
         }
         
         tbody.innerHTML = stats.map(stat => `
             <tr>
                 <td><strong>${stat.donation_name}</strong></td>
                 <td><span class="badge badge-info">${stat.access_count || 0}</span></td>
                 <td><span class="badge badge-success">${stat.unique_users || 0}</span></td>
                 <td>${stat.last_access ? new Date(stat.last_access).toLocaleDateString('he-IL') : 'אף פעם'}</td>
                 <td>${stat.most_active_user || 'ללא נתונים'}</td>
             </tr>
         `).join('');
     }

     // לוגי גישה
     function showDonationLogs() {
         openModal('donationLogsModal');
         loadDonationLogs();
     }

     async function loadDonationLogs() {
         try {
             const response = await fetch('/api/admin/donation-access-logs?limit=100', {
                 headers: { 'Authorization': `Bearer ${authToken}` }
             });
             
             if (response.ok) {
                 const logs = await response.json();
                 displayDonationLogs(logs);
             } else {
                 throw new Error('שגיאה בטעינת לוגים');
             }
         } catch (error) {
             console.error('❌ שגיאה בלוגים:', error);
             document.getElementById('donationLogsBody').innerHTML = 
                 '<tr><td colspan="5" class="text-center">שגיאה בטעינת נתונים</td></tr>';
         }
     }

     function displayDonationLogs(logs) {
         const tbody = document.getElementById('donationLogsBody');
         
         if (logs.length === 0) {
             tbody.innerHTML = `
                 <tr>
                     <td colspan="5" class="text-center">
                         <div class="empty-state">
                             <div class="empty-state-icon">📋</div>
                             <h3>אין לוגי גישה</h3>
                         </div>
                     </td>
                 </tr>
             `;
             return;
         }
         
         tbody.innerHTML = logs.map(log => `
             <tr>
                 <td>${new Date(log.created_at).toLocaleString('he-IL')}</td>
                 <td>${log.user_name || log.username || 'לא ידוע'}</td>
                 <td>${log.donation_name || 'לא ידוע'}</td>
                 <td>
                     <span class="badge ${log.action === 'VIEW' ? 'badge-info' : 'badge-success'}">
                         ${log.action === 'VIEW' ? '👁️ צפייה' : log.action === 'LOADED' ? '✅ נטען' : log.action}
                     </span>
                 </td>
                 <td>${log.ip_address || ''}</td>
             </tr>
         `).join('');
     }

// הוספת תורם חדש
async function handleAddDonor(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('donorName').value.trim(),
        phone: document.getElementById('donorPhone').value.trim(),
        email: document.getElementById('donorEmail').value.trim(),
        address: document.getElementById('donorAddress').value.trim(),
        city: document.getElementById('donorCity').value.trim(),
        donation_amount: parseFloat(document.getElementById('donorAmount').value) || null,
        donor_type: document.getElementById('donorType').value,
        notes: document.getElementById('donorNotes').value.trim()
    };
    
    if (!formData.name || !formData.phone) {
        showNotification('שם וטלפון נדרשים', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/donors', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('תורם נוסף בהצלחה! 👤', 'success');
            closeModal('addDonorModal');
            document.getElementById('addDonorForm').reset();
            loadDonors(); // רענון הרשימה
        } else {
            showNotification(data.error || 'שגיאה בהוספת תורם', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// עריכת תורם
function editDonor(id) {
    const donor = allDonors.find(d => d.id === id);
    if (!donor) {
        showNotification('תורם לא נמצא', 'error');
        return;
    }
    
    // מילוי הטופס
    document.getElementById('editDonorId').value = donor.id;
    document.getElementById('editDonorName').value = donor.name || '';
    document.getElementById('editDonorPhone').value = donor.phone || '';
    document.getElementById('editDonorEmail').value = donor.email || '';
    document.getElementById('editDonorCity').value = donor.city || '';
    document.getElementById('editDonorAddress').value = donor.address || '';
    document.getElementById('editDonorAmount').value = donor.donation_amount || '';
    document.getElementById('editDonorType').value = donor.donor_type || 'רגיל';
    document.getElementById('editDonorStatus').value = donor.status || 'active';
    document.getElementById('editDonorNotes').value = donor.notes || '';
    document.getElementById('editDonorCreated').value = new Date(donor.created_at).toLocaleDateString('he-IL');
    
    openModal('editDonorModal');
}

// שמירת עריכת תורם
async function handleEditDonor(e) {
    e.preventDefault();
    
    const id = document.getElementById('editDonorId').value;
    const formData = {
        name: document.getElementById('editDonorName').value.trim(),
        phone: document.getElementById('editDonorPhone').value.trim(),
        email: document.getElementById('editDonorEmail').value.trim(),
        address: document.getElementById('editDonorAddress').value.trim(),
        city: document.getElementById('editDonorCity').value.trim(),
        donation_amount: parseFloat(document.getElementById('editDonorAmount').value) || null,
        donor_type: document.getElementById('editDonorType').value,
        status: document.getElementById('editDonorStatus').value,
        notes: document.getElementById('editDonorNotes').value.trim()
    };
    
    try {
        const response = await fetch(`/api/admin/donors/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('תורם עודכן בהצלחה! ✏️', 'success');
            closeModal('editDonorModal');
            loadDonors();
        } else {
            showNotification(data.error || 'שגיאה בעדכון תורם', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// מחיקת תורם
async function deleteDonor() {
    const id = document.getElementById('editDonorId').value;
    
    if (!confirm('האם אתה בטוח שברצונך למחוק את התורם? פעולה זו לא ניתנת לביטול!')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/donors/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('תורם נמחק בהצלחה', 'success');
            closeModal('editDonorModal');
            loadDonors();
        } else {
            showNotification(data.error || 'שגיאה במחיקת תורם', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// אישור מחיקת תורם
function confirmDeleteDonor(id) {
    if (confirm('האם אתה בטוח שברצונך למחוק את התורם? פעולה זו לא ניתנת לביטול!')) {
        deleteDonorById(id);
    }
}

async function deleteDonorById(id) {
    try {
        const response = await fetch(`/api/admin/donors/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('תורם נמחק בהצלחה', 'success');
            loadDonors();
        } else {
            showNotification(data.error || 'שגיאה במחיקת תורם', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// עריכה קבוצתית
async function handleBulkEdit(e) {
    e.preventDefault();
    
    if (selectedDonors.size === 0) {
        showNotification('אנא בחר תורמים לעריכה', 'warning');
        return;
    }
    
    const updates = {};
    
    if (document.getElementById('bulkEditCity').checked) {
        updates.city = document.getElementById('bulkCityValue').value.trim();
    }
    if (document.getElementById('bulkEditType').checked) {
        updates.donor_type = document.getElementById('bulkTypeValue').value;
    }
    if (document.getElementById('bulkEditStatus').checked) {
        updates.status = document.getElementById('bulkStatusValue').value;
    }
    
    if (Object.keys(updates).length === 0) {
        showNotification('אנא בחר לפחות שדה אחד לעדכון', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/donors/bulk-edit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                donor_ids: Array.from(selectedDonors),
                updates: updates
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification(`${data.updated} תורמים עודכנו בהצלחה! 📝`, 'success');
            closeModal('bulkEditModal');
            clearSelection();
            loadDonors();
        } else {
            showNotification(data.error || 'שגיאה בעריכה קבוצתית', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// מחיקה קבוצתית
async function bulkDelete() {
    if (selectedDonors.size === 0) {
        showNotification('אנא בחר תורמים למחיקה', 'warning');
        return;
    }
    
    if (!confirm(`האם אתה בטוח שברצונך למחוק ${selectedDonors.size} תורמים? פעולה זו לא ניתנת לביטול!`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/admin/donors/bulk-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                donor_ids: Array.from(selectedDonors)
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification(`${data.deleted} תורמים נמחקו בהצלחה`, 'success');
            clearSelection();
            loadDonors();
        } else {
            showNotification(data.error || 'שגיאה במחיקה קבוצתית', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// ייצוא תורמים
async function exportDonors() {
    try {
        const response = await fetch('/api/admin/export/donors', {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'donors_export.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showNotification('תורמים יוצאו בהצלחה! 📊', 'success');
        } else {
            showNotification('שגיאה בייצוא תורמים', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// === פונקציות ניהול משתמשים ===

// הוספת משתמש חדש
async function handleAddUser(e) {
    e.preventDefault();
    
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const confirmPassword = document.getElementById('confirmUserPassword').value;
    const fullName = document.getElementById('newUserFullName').value.trim();
    
    // בדיקות וולידציה
    if (!username || !password || !fullName) {
        showNotification('שם משתמש, סיסמה ושם מלא נדרשים', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showNotification('הסיסמאות אינן תואמות', 'error');
        return;
    }
    
    if (password.length < 6) {
        showNotification('הסיסמה חייבת להכיל לפחות 6 תווים', 'error');
        return;
    }
    
    // בדיקת זמינות שם המשתמש
    try {
        const checkResponse = await fetch(`/api/admin/check-username/${encodeURIComponent(username)}`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (checkResponse.ok) {
            const checkData = await checkResponse.json();
            if (!checkData.available) {
                showNotification('שם המשתמש כבר קיים במערכת. אנא בחר שם משתמש אחר.', 'error');
                document.getElementById('newUsername').focus();
                return;
            }
        }
    } catch (error) {
        console.error('שגיאה בבדיקת שם משתמש:', error);
    }
    
    const formData = {
        username: username,
        password: password,
        full_name: fullName,
        email: document.getElementById('newUserEmail').value.trim(),
        phone: document.getElementById('newUserPhone').value.trim(),
        department: document.getElementById('newUserDepartment').value.trim(),
        role: document.getElementById('newUserRole').value,
        notes: document.getElementById('newUserNotes').value.trim()
    };
    
    try {
        const response = await fetch('/api/admin/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('משתמש נוצר בהצלחה! 👤', 'success');
            closeModal('addUserModal');
            document.getElementById('addUserForm').reset();
            loadUsers();
        } else {
            showNotification(data.error || 'שגיאה ביצירת משתמש', 'error');
            
            // אם השגיאה היא שם משתמש קיים, פוקוס על השדה
            if (data.error && data.error.includes('כבר קיים')) {
                document.getElementById('newUsername').focus();
                document.getElementById('newUsername').select();
            }
        }
    } catch (error) {
        console.error('שגיאה ביצירת משתמש:', error);
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// הוספת בדיקה דינמית לשם משתמש בזמן הקלדה
document.addEventListener('DOMContentLoaded', function() {
    const usernameInput = document.getElementById('newUsername');
    if (usernameInput) {
        let checkTimeout;
        
        usernameInput.addEventListener('input', function() {
            clearTimeout(checkTimeout);
            const username = this.value.trim();
            
            if (username.length >= 3) {
                // הוספת אינדיקטור בדיקה
                this.style.borderColor = '#ffc107';
                
                checkTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`/api/admin/check-username/${encodeURIComponent(username)}`, {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.available) {
                                usernameInput.style.borderColor = '#28a745';
                                usernameInput.title = 'שם המשתמש זמין ✓';
                            } else {
                                usernameInput.style.borderColor = '#dc3545';
                                usernameInput.title = 'שם המשתמש כבר קיים ✗';
                            }
                        }
                    } catch (error) {
                        console.error('שגיאה בבדיקת שם משתמש:', error);
                        usernameInput.style.borderColor = '';
                        usernameInput.title = '';
                    }
                }, 500);
            } else {
                this.style.borderColor = '';
                this.title = '';
            }
        });
    }
});

// פונקציה להצגת רשימת משתמשים קיימים (לעזרה בבחירת שם)
function showExistingUsernames() {
    if (allUsers && allUsers.length > 0) {
        const existingUsernames = allUsers.map(user => user.username).join(', ');
        showNotification(`שמות משתמש קיימים: ${existingUsernames}`, 'info', 8000);
    }
}

// פונקציה לגנרציה אוטומטית של שם משתמש
function generateUsername() {
    const fullName = document.getElementById('newUserFullName').value.trim();
    const usernameInput = document.getElementById('newUsername');
    
    if (fullName) {
        // יצירת שם משתמש מהשם המלא
        const names = fullName.split(' ');
        let suggestion = '';
        
        if (names.length >= 2) {
            // שם פרטי + אות ראשונה של שם משפחה
            suggestion = names[0] + names[1].charAt(0);
        } else {
            suggestion = names[0];
        }
        
        // הסרת תווים מיוחדים והמרה לאנגלית (בסיסית)
        suggestion = suggestion.replace(/[^a-zA-Z0-9א-ת]/g, '');
        
        // אם יש עברית, המרה בסיסית לאנגלית
        const hebrewToEnglish = {
            'א': 'a', 'ב': 'b', 'ג': 'g', 'ד': 'd', 'ה': 'h', 'ו': 'v', 'ז': 'z', 'ח': 'h',
            'ט': 't', 'י': 'y', 'כ': 'k', 'ך': 'k', 'ל': 'l', 'מ': 'm', 'ם': 'm', 'ן': 'n',
            'נ': 'n', 'ס': 's', 'ע': 'a', 'פ': 'p', 'ף': 'p', 'צ': 'z', 'ץ': 'z', 'ק': 'k',
            'ר': 'r', 'ש': 's', 'ת': 't'
        };
        
        suggestion = suggestion.split('').map(char => hebrewToEnglish[char] || char).join('');
        suggestion = suggestion.toLowerCase();
        
        usernameInput.value = suggestion;
        
        // הפעלת בדיקת זמינות
        usernameInput.dispatchEvent(new Event('input'));
    }
}

// עריכת משתמש
function editUser(id) {
    const user = allUsers.find(u => u.id === id);
    if (!user) {
        showNotification('משתמש לא נמצא', 'error');
        return;
    }
    
    // מילוי הטופס
    document.getElementById('editUserId').value = user.id;
    document.getElementById('editUsername').value = user.username || '';
    document.getElementById('editUserFullName').value = user.full_name || '';
    document.getElementById('editUserEmail').value = user.email || '';
    document.getElementById('editUserPhone').value = user.phone || '';
    document.getElementById('editUserDepartment').value = user.department || '';
    document.getElementById('editUserRole').value = user.role || 'operator';
    document.getElementById('editUserStatus').value = user.is_active ? '1' : '0';
    document.getElementById('editUserLastLogin').value = user.last_login ? 
        new Date(user.last_login).toLocaleString('he-IL') : 'אף פעם';
    document.getElementById('editUserNotes').value = user.notes || '';
    
    openModal('editUserModal');
}

// שמירת עריכת משתמש
async function handleEditUser(e) {
    e.preventDefault();
    
    const id = document.getElementById('editUserId').value;
    const formData = {
        full_name: document.getElementById('editUserFullName').value.trim(),
        email: document.getElementById('editUserEmail').value.trim(),
        phone: document.getElementById('editUserPhone').value.trim(),
        department: document.getElementById('editUserDepartment').value.trim(),
        role: document.getElementById('editUserRole').value,
        is_active: document.getElementById('editUserStatus').value === '1',
        notes: document.getElementById('editUserNotes').value.trim()
    };
    
    const password = document.getElementById('editUserPassword').value.trim();
    if (password) {
        formData.password = password;
    }
    
    try {
        const response = await fetch(`/api/admin/users/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('משתמש עודכן בהצלחה! ✏️', 'success');
            closeModal('editUserModal');
            loadUsers();
        } else {
            showNotification(data.error || 'שגיאה בעדכון משתמש', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// איפוס סיסמה
async function resetUserPassword(userId) {
    const newPassword = prompt('הכנס סיסמה חדשה (מינימום 6 תווים):');
    
    if (!newPassword || newPassword.length < 6) {
        showNotification('סיסמה חדשה נדרשת (מינימום 6 תווים)', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ new_password: newPassword })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('סיסמה אופסה בהצלחה! 🔒', 'success');
        } else {
            showNotification(data.error || 'שגיאה באיפוס סיסמה', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// מחיקת משתמש
function confirmDeleteUser(id) {
    if (confirm('האם אתה בטוח שברצונך למחוק את המשתמש? פעולה זו לא ניתנת לביטול!')) {
        deleteUser(id);
    }
}

async function deleteUser(id) {
   try {
       const response = await fetch(`/api/admin/users/${id}`, {
           method: 'DELETE',
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       const data = await response.json();
       
       if (response.ok) {
           showNotification('משתמש נמחק בהצלחה', 'success');
           loadUsers();
       } else {
           showNotification(data.error || 'שגיאה במחיקת משתמש', 'error');
       }
   } catch (error) {
       showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

// צפייה בלוגי משתמש
async function viewUserLogs(userId) {
   try {
       const response = await fetch(`/api/admin/logs/user/${userId}`, {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (response.ok) {
           const logs = await response.json();
           displayUserLogsModal(logs);
       } else {
           showNotification('שגיאה בטעינת לוגי משתמש', 'error');
       }
   } catch (error) {
       showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

function displayUserLogsModal(logs) {
   const modal = document.createElement('div');
   modal.className = 'modal show';
   modal.innerHTML = `
       <div class="modal-content">
           <div class="modal-header">
               <h3>📋 לוגי משתמש</h3>
               <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
           </div>
           <div style="max-height: 400px; overflow-y: auto;">
               ${logs.length === 0 ? 
                   '<div class="empty-state"><div class="empty-state-icon">📋</div><h3>אין פעילות</h3></div>' :
                   `<table class="table">
                       <thead>
                           <tr>
                               <th>זמן</th>
                               <th>פעולה</th>
                               <th>פרטים</th>
                               <th>IP</th>
                           </tr>
                       </thead>
                       <tbody>
                           ${logs.map(log => `
                               <tr>
                                   <td>${new Date(log.created_at).toLocaleString('he-IL')}</td>
                                   <td>${getActivityText(log.action)}</td>
                                   <td>${log.details || ''}</td>
                                   <td>${log.ip_address || ''}</td>
                               </tr>
                           `).join('')}
                       </tbody>
                   </table>`
               }
           </div>
       </div>
   `;
   document.body.appendChild(modal);
}

// === פונקציות הודעות מערכת ===

// טעינת הודעות
async function loadMessages() {
   try {
       showLoading('messagesTableBody');
       
       const response = await fetch('/api/admin/messages', {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (response.ok) {
           const messages = await response.json();
           displayMessages(messages);
       } else {
           throw new Error('שגיאה בטעינת הודעות');
       }
   } catch (error) {
       console.error('❌ שגיאה בטעינת הודעות:', error);
       document.getElementById('messagesTableBody').innerHTML = 
           '<tr><td colspan="9" class="text-center">שגיאה בטעינת נתונים</td></tr>';
   }
}

function displayMessages(messages) {
   const tbody = document.getElementById('messagesTableBody');
   
   if (messages.length === 0) {
       tbody.innerHTML = `
           <tr>
               <td colspan="9" class="text-center">
                   <div class="empty-state">
                       <div class="empty-state-icon">💬</div>
                       <h3>אין הודעות במערכת</h3>
                       <p>צור הודעה ראשונה</p>
                   </div>
               </td>
           </tr>
       `;
       return;
   }
   
   tbody.innerHTML = messages.map(msg => `
       <tr>
           <td><strong>${msg.title}</strong></td>
           <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
               ${msg.content}
           </td>
           <td>
               <span class="badge ${getMessageTypeBadge(msg.type)}">
                   ${getMessageTypeText(msg.type)}
               </span>
           </td>
           <td>${getTargetText(msg.target_role, msg.target_user_id)}</td>
           <td>
               <span class="badge ${getPriorityBadge(msg.priority)}">
                   ${getPriorityText(msg.priority)}
               </span>
           </td>
           <td>${new Date(msg.created_at).toLocaleDateString('he-IL')}</td>
           <td>${msg.expires_at ? new Date(msg.expires_at).toLocaleDateString('he-IL') : 'ללא תפוגה'}</td>
           <td>
               <span class="badge ${msg.is_active ? 'badge-success' : 'badge-secondary'}">
                   ${msg.is_active ? 'פעיל' : 'לא פעיל'}
               </span>
           </td>
           <td>
               <button class="btn btn-info btn-sm" onclick="editMessage(${msg.id})" title="עריכה">
                   ✏️
               </button>
               <button class="btn btn-danger btn-sm" onclick="deleteMessage(${msg.id})" title="מחיקה">
                   🗑️
               </button>
           </td>
       </tr>
   `).join('');
}

function getMessageTypeBadge(type) {
   const badgeMap = {
       'info': 'badge-info',
       'success': 'badge-success',
       'warning': 'badge-warning',
       'error': 'badge-danger'
   };
   return badgeMap[type] || 'badge-info';
}

function getMessageTypeText(type) {
   const textMap = {
       'info': 'מידע',
       'success': 'הצלחה',
       'warning': 'אזהרה',
       'error': 'שגיאה'
   };
   return textMap[type] || type;
}

function getPriorityBadge(priority) {
   const badgeMap = {
       1: 'badge-secondary',
       2: 'badge-warning',
       3: 'badge-danger'
   };
   return badgeMap[priority] || 'badge-secondary';
}

function getPriorityText(priority) {
   const textMap = {
       1: 'רגילה',
       2: 'חשובה',
       3: 'קריטית'
   };
   return textMap[priority] || 'רגילה';
}

function getTargetText(target_role, target_user_id) {
   if (target_user_id) return 'משתמש ספציפי';
   if (target_role === 'admin') return 'אדמינים';
   if (target_role === 'operator') return 'טלפנים';
   return 'כל המשתמשים';
}

// יצירת הודעה חדשה
async function handleCreateMessage(e) {
   e.preventDefault();
   
   const formData = {
       title: document.getElementById('messageTitle').value.trim(),
       content: document.getElementById('messageContent').value.trim(),
       type: document.getElementById('messageType').value,
       priority: parseInt(document.getElementById('messagePriority').value),
       target_role: document.getElementById('messageTarget').value === 'all' ? null : 
                   document.getElementById('messageTarget').value === 'specific' ? null :
                   document.getElementById('messageTarget').value,
       target_user_id: document.getElementById('messageTarget').value === 'specific' ? 
                       parseInt(document.getElementById('targetUserId').value) || null : null,
       expires_at: document.getElementById('messageExpires').value || null
   };
   
   try {
       const response = await fetch('/api/admin/messages', {
           method: 'POST',
           headers: {
               'Content-Type': 'application/json',
               'Authorization': `Bearer ${authToken}`
           },
           body: JSON.stringify(formData)
       });
       
       const data = await response.json();
       
       if (response.ok) {
           showNotification('הודעה נוצרה בהצלחה! 💬', 'success');
           closeModal('createMessageModal');
           document.getElementById('createMessageForm').reset();
           loadMessages();
       } else {
           showNotification(data.error || 'שגיאה ביצירת הודעה', 'error');
       }
   } catch (error) {
       showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

// הצגה/הסתרה של בחירת משתמש ספציפי
function toggleTargetUser() {
   const target = document.getElementById('messageTarget').value;
   const userGroup = document.getElementById('specificUserGroup');
   
   if (target === 'specific') {
       userGroup.style.display = 'block';
   } else {
       userGroup.style.display = 'none';
   }
}

// עריכת הודעה
function editMessage(id) {
   // לצורך הדוגמה - תוכל להוסיף מודל עריכה
   showNotification('פונקציית עריכה תתווסף בקרוב', 'info');
}

// מחיקת הודעה
async function deleteMessage(id) {
   if (!confirm('האם אתה בטוח שברצונך למחוק את ההודעה?')) {
       return;
   }
   
   try {
       const response = await fetch(`/api/admin/messages/${id}`, {
           method: 'DELETE',
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       const data = await response.json();
       
       if (response.ok) {
           showNotification('הודעה נמחקה בהצלחה', 'success');
           loadMessages();
       } else {
           showNotification(data.error || 'שגיאה במחיקת הודעה', 'error');
       }
   } catch (error) {
       showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

// === פונקציות כרטיסי תמיכה ===

// הוסף את הפונקציות הללו ב-admin.html לפני הפונקציה loadTickets

function getCategoryText(category) {
    const categoryMap = {
        'technical': 'בעיה טכנית',
        'data': 'בעיה בנתונים', 
        'access': 'בעיית גישה',
        'training': 'הדרכה',
        'general': 'כללי',
        'other': 'אחר'
    };
    return categoryMap[category] || category;
}

function getStatusText(status) {
    const statusMap = {
        'open': 'פתוח',
        'in_progress': 'בטיפול',
        'resolved': 'נפתר', 
        'closed': 'סגור'
    };
    return statusMap[status] || status;
}

function getStatusColor(status) {
    const colorMap = {
        'open': 'btn-warning',
        'in_progress': 'btn-info',
        'resolved': 'btn-success',
        'closed': 'btn-secondary'
    };
    return colorMap[status] || 'btn-secondary';
}

function getPriorityText(priority) {
    const priorityMap = {
        'low': 'נמוכה',
        'medium': 'בינונית', 
        'high': 'גבוהה',
        'urgent': 'דחוף'
    };
    return priorityMap[priority] || priority;
}

// טעינת כרטיסים
async function loadTickets() {
   try {
       showLoading('ticketsTableBody');
       
       const response = await fetch('/api/admin/tickets', {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (response.ok) {
           const tickets = await response.json();
           displayTickets(tickets);
           updateTicketStats(tickets);
       } else {
           throw new Error('שגיאה בטעינת כרטיסים');
       }
   } catch (error) {
       console.error('❌ שגיאה בטעינת כרטיסים:', error);
       document.getElementById('ticketsTableBody').innerHTML = 
           '<tr><td colspan="10" class="text-center">שגיאה בטעינת נתונים</td></tr>';
   }
}

function displayTickets(tickets) {
   const tbody = document.getElementById('ticketsTableBody');
   
   if (tickets.length === 0) {
       tbody.innerHTML = `
           <tr>
               <td colspan="10" class="text-center">
                   <div class="empty-state">
                       <div class="empty-state-icon">🎫</div>
                       <h3>אין כרטיסי תמיכה</h3>
                       <p>כל הכרטיסים יופיעו כאן</p>
                   </div>
               </td>
           </tr>
       `;
       return;
   }
   
   tbody.innerHTML = tickets.map(ticket => `
       <tr>
           <td><strong>#${ticket.id}</strong></td>
           <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
               ${ticket.title}
           </td>
           <td>${ticket.creator_name || 'לא ידוע'}</td>
           <td>
               <span class="badge badge-info">
                   ${getCategoryText(ticket.category)}
               </span>
           </td>
           <td>
               <span class="badge ${getPriorityBadgeFromText(ticket.priority)}">
                   ${getPriorityTextFromValue(ticket.priority)}
               </span>
           </td>
           <td>
               <span class="badge ${getTicketStatusBadge(ticket.status)}">
                   ${getTicketStatusText(ticket.status)}
               </span>
           </td>
           <td>${ticket.assigned_name || 'לא מוקצה'}</td>
           <td>${new Date(ticket.created_at).toLocaleDateString('he-IL')}</td>
           <td>${new Date(ticket.updated_at).toLocaleDateString('he-IL')}</td>
           <td>
               <button class="btn btn-info btn-sm" onclick="viewTicketDetails(${ticket.id})" title="פרטים">
                   👁️
               </button>
               <button class="btn btn-warning btn-sm" onclick="assignTicket(${ticket.id})" title="הקצה">
                   👨‍💼
               </button>
               <button class="btn btn-success btn-sm" onclick="updateTicketStatus(${ticket.id})" title="עדכן סטטוס">
                   🔄
               </button>
           </td>
       </tr>
   `).join('');
}

function updateTicketStats(tickets) {
   const pending = tickets.filter(t => t.status === 'open').length;
   const inProgress = tickets.filter(t => t.status === 'in_progress').length;
   
   document.getElementById('pendingTickets').textContent = `${pending} ממתינים`;
   document.getElementById('inProgressTickets').textContent = `${inProgress} בטיפול`;
}

function getTicketStatusBadge(status) {
   const badgeMap = {
       'open': 'badge-warning',
       'in_progress': 'badge-info',
       'resolved': 'badge-success',
       'closed': 'badge-secondary'
   };
   return badgeMap[status] || 'badge-secondary';
}

function getTicketStatusText(status) {
   const textMap = {
       'open': 'פתוח',
       'in_progress': 'בטיפול',
       'resolved': 'נפתר',
       'closed': 'סגור'
   };
   return textMap[status] || status;
}

function getPriorityBadgeFromText(priority) {
   const badgeMap = {
       'urgent': 'badge-danger',
       'high': 'badge-warning',
       'medium': 'badge-info',
       'low': 'badge-secondary'
   };
   return badgeMap[priority] || 'badge-secondary';
}

function getPriorityTextFromValue(priority) {
   const textMap = {
       'urgent': 'דחוף',
       'high': 'גבוהה',
       'medium': 'בינונית',
       'low': 'נמוכה'
   };
   return textMap[priority] || priority;
}

async function viewTicketDetails(ticketId) {
    try {
        const response = await fetch(`/api/admin/tickets/${ticketId}/details`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.ok) {
            const ticket = await response.json();
            displayTicketDetailsModal(ticket);
        } else {
            showNotification('שגיאה בטעינת פרטי כרטיס', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

function displayTicketDetailsModal(ticket) {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>🎫 כרטיס תמיכה #${ticket.id}</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div>
                <div class="card">
                    <h4>${ticket.title}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                        <div>
                            <strong>👤 נוצר על ידי:</strong> ${ticket.creator_name || 'לא ידוע'}
                        </div>
                        <div>
                            <strong>📂 קטגוריה:</strong> ${getCategoryText(ticket.category)}
                        </div>
                        <div>
                            <strong>⚡ עדיפות:</strong> 
                            <span class="badge ${getPriorityBadgeFromText(ticket.priority)}">
                                ${getPriorityTextFromValue(ticket.priority)}
                            </span>
                        </div>
                        <div>
                            <strong>📊 סטטוס:</strong>
                            <span class="badge ${getTicketStatusBadge(ticket.status)}">
                                ${getTicketStatusText(ticket.status)}
                            </span>
                        </div>
                        <div>
                            <strong>👨‍💼 מטפל:</strong> ${ticket.assigned_name || 'לא מוקצה'}
                        </div>
                        <div>
                            <strong>📅 נוצר:</strong> ${new Date(ticket.created_at).toLocaleString('he-IL')}
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <strong>📝 תיאור הבעיה:</strong>
                        <div style="background: #e2edfb; padding: 15px; border-radius: 8px; margin-top: 10px;">
                            ${ticket.description}
                        </div>
                    </div>
                    
                    ${ticket.responses && ticket.responses.length > 0 ? `
                        <div style="margin: 20px 0;">
                            <strong>💬 תגובות:</strong>
                            <div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                                ${ticket.responses.map(response => `
                                    <div style="background: ${response.is_internal ? '#fff3cd' : '#000000'}; 
                                                padding: 10px; margin: 10px 0; border-radius: 8px; 
                                                border-right: 4px solid ${response.is_internal ? '#ffc107' : '#007bff'};">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <strong>${response.user_name}</strong>
                                            <small>${new Date(response.created_at).toLocaleString('he-IL')}</small>
                                        </div>
                                        <div>${response.content}</div>
                                        ${response.is_internal ? '<small style="color: #856404;">💼 תגובה פנימית</small>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 25px; text-align: center;">
                        <button class="btn btn-warning" onclick="showAssignTicketModal(${ticket.id}, '${ticket.assigned_to || ''}')">
                            👨‍💼 הקצה מטפל
                        </button>
                        <button class="btn btn-info" onclick="showUpdateStatusModal(${ticket.id}, '${ticket.status}')">
                            🔄 עדכן סטטוס
                        </button>
                        <button class="btn btn-success" onclick="showAddResponseModal(${ticket.id})">
                            💬 הוסף תגובה
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            ❌ סגור
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function assignTicket(ticketId, currentAssigned = '') {
    showAssignTicketModal(ticketId, currentAssigned);
}

function showAssignTicketModal(ticketId, currentAssigned) {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>👨‍💼 הקצאת מטפל לכרטיס</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label>בחר מטפל:</label>
                    <select id="assignUserSelect" class="form-control">
                        <option value="">בחר מטפל...</option>
                        ${allUsers.filter(u => u.role === 'admin').map(user => `
                            <option value="${user.id}" ${user.id == currentAssigned ? 'selected' : ''}>
                                ${user.full_name || user.username}
                            </option>
                        `).join('')}
                    </select>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="executeAssignTicket(${ticketId}); this.closest('.modal').remove();">
                        ✅ הקצה
                    </button>
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                        ❌ בטל
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function executeAssignTicket(ticketId) {
    const assignedTo = document.getElementById('assignUserSelect').value;
    
    if (!assignedTo) {
        showNotification('אנא בחר מטפל', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/tickets/${ticketId}/assign`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ assigned_to: parseInt(assignedTo) })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('כרטיס הוקצה בהצלחה! 👨‍💼', 'success');
            loadTickets();
        } else {
            showNotification(data.error || 'שגיאה בהקצאת כרטיס', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

function updateTicketStatus(ticketId, currentStatus = 'open') {
    showUpdateStatusModal(ticketId, currentStatus);
}

// סינון כרטיסים
function filterTickets() {
   // הפונקציה תקרא שוב ל-loadTickets עם פרמטרי סינון
   loadTickets();
}

function showUpdateStatusModal(ticketId, currentStatus) {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>🔄 עדכון סטטוס כרטיס</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label>בחר סטטוס חדש:</label>
                    <select id="statusSelect" class="form-control">
                        <option value="open" ${currentStatus === 'open' ? 'selected' : ''}>🔴 פתוח</option>
                        <option value="in_progress" ${currentStatus === 'in_progress' ? 'selected' : ''}>🔵 בטיפול</option>
                        <option value="resolved" ${currentStatus === 'resolved' ? 'selected' : ''}>🟢 נפתר</option>
                        <option value="closed" ${currentStatus === 'closed' ? 'selected' : ''}>⚫ סגור</option>
                    </select>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="executeUpdateStatus(${ticketId}); this.closest('.modal').remove();">
                        ✅ עדכן
                    </button>
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                        ❌ בטל
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function executeUpdateStatus(ticketId) {
    const newStatus = document.getElementById('statusSelect').value;
    
    try {
        const response = await fetch(`/api/admin/tickets/${ticketId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('סטטוס כרטיס עודכן בהצלחה! 🔄', 'success');
            loadTickets();
        } else {
            showNotification(data.error || 'שגיאה בעדכון סטטוס', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// הוספת תגובה לכרטיס
function showAddResponseModal(ticketId) {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>💬 הוספת תגובה לכרטיס</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label>תוכן התגובה:</label>
                    <textarea id="responseContent" class="form-control" rows="4" 
                              placeholder="כתב תגובה או פתרון לבעיה..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isInternal"> 
                        💼 תגובה פנימית (רק לאדמינים)
                    </label>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="executeAddResponse(${ticketId}); this.closest('.modal').remove();">
                        💬 שלח תגובה
                    </button>
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                        ❌ בטל
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function executeAddResponse(ticketId) {
    const content = document.getElementById('responseContent').value.trim();
    const isInternal = document.getElementById('isInternal').checked;
    
    if (!content) {
        showNotification('אנא הכנס תוכן לתגובה', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/tickets/${ticketId}/response`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ content, is_internal: isInternal ? 1 : 0 })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('תגובה נוספה בהצלחה! 💬', 'success');
            loadTickets();
        } else {
            showNotification(data.error || 'שגיאה בהוספת תגובה', 'error');
        }
    } catch (error) {
        showNotification('שגיאת תקשורת עם השרת', 'error');
    }
}

// === פונקציות דוחות ===

// טעינת דוחות
async function loadReports() {
   try {
       // דוח חיפושים
       const searchResponse = await fetch('/api/admin/reports/searches', {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (searchResponse.ok) {
           const searchData = await searchResponse.json();
           displaySearchReport(searchData);
       }
       
       // דפוסי עבודה
       const patternsResponse = await fetch('/api/admin/reports/work-patterns', {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (patternsResponse.ok) {
           const patternsData = await patternsResponse.json();
           displayWorkPatterns(patternsData);
       }
       
   } catch (error) {
       console.error('❌ שגיאה בטעינת דוחות:', error);
   }
}

function displaySearchReport(data) {
   const tbody = document.getElementById('searchReportBody');
   
   if (data.length === 0) {
       tbody.innerHTML = `
           <tr>
               <td colspan="6" class="text-center">
                   <div class="empty-state">
                       <div class="empty-state-icon">📊</div>
                       <h3>אין נתוני חיפושים</h3>
                   </div>
               </td>
           </tr>
       `;
       return;
   }
   
   tbody.innerHTML = data.map(row => `
       <tr>
           <td>${row.full_name || row.username}</td>
           <td>${row.search_date}</td>
           <td><strong>${row.total_searches}</strong></td>
           <td>${row.unique_searches}</td>
           <td>${Math.round(row.avg_results * 100) / 100}</td>
           <td>8 שעות</td>
       </tr>
   `).join('');
}

function displayWorkPatterns(data) {
   // הצגת גרפים - תוכל להוסיף Chart.js כאן
   console.log('Work patterns data:', data);
}

// עדכון דוחות עם סינונים
function updateReports() {
   const fromDate = document.getElementById('fromDate').value;
   const toDate = document.getElementById('toDate').value;
   const userId = document.getElementById('userReportFilter').value;
   
   // טעינה מחדש עם פרמטרים
   loadReports();
}

// ייצוא דוחות
async function exportReports() {
   try {
       const fromDate = document.getElementById('fromDate').value;
       const toDate = document.getElementById('toDate').value;
       
       let url = '/api/admin/export/reports';
       const params = new URLSearchParams();
       
       if (fromDate) params.append('from_date', fromDate);
       if (toDate) params.append('to_date', toDate);
       
       if (params.toString()) {
           url += '?' + params.toString();
       }
       
       const response = await fetch(url, {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (response.ok) {
           const blob = await response.blob();
           const downloadUrl = window.URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = downloadUrl;
           a.download = 'search_reports_export.csv';
           document.body.appendChild(a);
           a.click();
           window.URL.revokeObjectURL(downloadUrl);
           document.body.removeChild(a);
           showNotification('דוחות יוצאו בהצלחה! 📊', 'success');
       } else {
           showNotification('שגיאה בייצוא דוחות', 'error');
       }
   } catch (error) {
       showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

// יצירת דוח מותאם
function generateReport() {
   showNotification('פונקציית יצירת דוח מותאם תתווסף בקרוב', 'info');
}

// === פונקציות העלאת קבצים ===

// בחירת קובץ
function handleFileSelect(input) {
   const file = input.files[0];
   if (file) {
       displayFileDetails(file);
   }
}

// drag & drop
function handleDrop(e) {
   e.preventDefault();
   e.currentTarget.classList.remove('dragover');
   
   const files = e.dataTransfer.files;
   if (files.length > 0) {
       displayFileDetails(files[0]);
   }
}

function displayFileDetails(file) {
   document.getElementById('fileName').value = file.name;
   document.getElementById('fileSize').value = formatFileSize(file.size);
   document.getElementById('fileType').value = file.type || 'text/csv';
   
   document.getElementById('fileDetails').classList.remove('hidden');
}

function formatFileSize(bytes) {
   if (bytes === 0) return '0 Bytes';
   const k = 1024;
   const sizes = ['Bytes', 'KB', 'MB', 'GB'];
   const i = Math.floor(Math.log(bytes) / Math.log(k));
   return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// העלאת קובץ CSV
async function uploadCSV() {
   const fileInput = document.getElementById('csvFile');
   const file = fileInput.files[0];
   
   if (!file) {
       showNotification('אנא בחר קובץ CSV', 'warning');
       return;
   }
   
   const formData = new FormData();
   formData.append('csvFile', file);
   
   // הצגת progress bar
   document.getElementById('uploadProgress').classList.remove('hidden');
   const progressBar = document.getElementById('progressBar');
   const progressText = document.getElementById('progressText');
   
   try {
       // שימוש ב-XMLHttpRequest לצורך progress tracking
       const xhr = new XMLHttpRequest();
       
       xhr.upload.addEventListener('progress', (e) => {
           if (e.lengthComputable) {
               const percentComplete = (e.loaded / e.total) * 100;
               progressBar.style.width = percentComplete + '%';
               progressText.textContent = Math.round(percentComplete) + '%';
           }
       });
       
       xhr.addEventListener('load', () => {
           if (xhr.status === 200) {
               const response = JSON.parse(xhr.responseText);
               showNotification(`הועלו בהצלחה ${response.message}! 📄`, 'success');
               cancelUpload();
               loadUploadHistory();
           } else {
               const error = JSON.parse(xhr.responseText);
               showNotification(error.error || 'שגיאה בהעלאה', 'error');
           }
       });
       
       xhr.addEventListener('error', () => {
           showNotification('שגיאת תקשורת בהעלאה', 'error');
       });
       
       xhr.open('POST', '/api/admin/upload-csv');
       xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
       xhr.send(formData);
       
   } catch (error) {
       showNotification('שגיאה בהעלאת קובץ', 'error');
       console.error('Upload error:', error);
   }
}

// ביטול העלאה
function cancelUpload() {
   document.getElementById('fileDetails').classList.add('hidden');
   document.getElementById('uploadProgress').classList.add('hidden');
   document.getElementById('csvFile').value = '';
   document.getElementById('progressBar').style.width = '0%';
   document.getElementById('progressText').textContent = '0%';
}

// טעינת היסטוריית העלאות
async function loadUploadHistory() {
   try {
       const response = await fetch('/api/admin/upload-history', {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (response.ok) {
           const history = await response.json();
           displayUploadHistory(history);
       }
   } catch (error) {
       console.error('❌ שגיאה בטעינת היסטוריית העלאות:', error);
   }
}

function displayUploadHistory(history) {
   const tbody = document.getElementById('uploadHistoryBody');
   
   if (history.length === 0) {
       tbody.innerHTML = `
           <tr>
               <td colspan="7" class="text-center">
                   <div class="empty-state">
                       <div class="empty-state-icon">📚</div>
                       <h3>אין היסטוריית העלאות</h3>
                   </div>
               </td>
           </tr>
       `;
       return;
   }
   
   tbody.innerHTML = history.map(item => `
       <tr>
           <td>${new Date(item.created_at).toLocaleDateString('he-IL')}</td>
           <td><strong>${item.file_name || 'לא ידוע'}</strong></td>
           <td>${item.full_name || item.username}</td>
           <td><strong>${item.uploaded_count || 0}</strong></td>
           <td>${item.duplicates_count || 0}</td>
           <td>${item.errors_count || 0}</td>
           <td>
               <span class="badge ${item.errors_count > 0 ? 'badge-warning' : 'badge-success'}">
                   ${item.errors_count > 0 ? 'עם שגיאות' : 'הושלם'}
               </span>
           </td>
       </tr>
   `).join('');
}

function extractNumberFromDetails(details, type) {
   if (!details) return '0';
   const regex = new RegExp(`(\\d+)\\s+${type}`, 'i');
   const match = details.match(regex);
   return match ? match[1] : '0';
}

// הורדת תבנית CSV
async function downloadTemplate() {
   try {
       const response = await fetch('/api/admin/template/donors-csv', {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (response.ok) {
           const blob = await response.blob();
           const url = window.URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = 'donors_template.csv';
           document.body.appendChild(a);
           a.click();
           window.URL.revokeObjectURL(url);
           document.body.removeChild(a);
           showNotification('תבנית CSV הורדה בהצלחה! 📋', 'success');
       } else {
           showNotification('שגיאה בהורדת תבנית', 'error');
       }
   } catch (error) {
       showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

// בדיקת איכות נתונים
async function showDataQuality() {
   try {
       const response = await fetch('/api/admin/data-quality', {
           method: 'POST',
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (response.ok) {
           const data = await response.json();
           displayDataQualityModal(data);
       } else {
           showNotification('שגיאה בבדיקת איכות נתונים', 'error');
       }
   } catch (error) {
   showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

function displayDataQualityModal(data) {
   const modal = document.createElement('div');
   modal.className = 'modal show';
   modal.innerHTML = `
       <div class="modal-content">
           <div class="modal-header">
               <h3>🔍 בדיקת איכות נתונים</h3>
               <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
           </div>
           <div>
               <div class="message info">
                   <span>📊 תוצאות בדיקת איכות הנתונים במערכת</span>
               </div>
               
               <div style="margin: 20px 0;">
                   <h4>🔍 בעיות שנמצאו:</h4>
                   
                   <div class="card" style="margin: 10px 0; padding: 15px;">
                       <h5>👤 תורמים ללא שם</h5>
                       <p><strong>${data['תורמים ללא שם'] || 0}</strong> תורמים</p>
                   </div>
                   
                   <div class="card" style="margin: 10px 0; padding: 15px;">
                       <h5>📞 תורמים ללא טלפון</h5>
                       <p><strong>${data['תורמים ללא טלפון'] || 0}</strong> תורמים</p>
                   </div>
                   
                   <div class="card" style="margin: 10px 0; padding: 15px;">
                       <h5>📧 אימיילים לא תקינים</h5>
                       <p><strong>${data['אימיילים לא תקינים'] || 0}</strong> תורמים</p>
                   </div>
                   
                   <div class="card" style="margin: 10px 0; padding: 15px;">
                       <h5>🔄 כפילויות בטלפון</h5>
                       <p><strong>${Array.isArray(data['כפילויות בטלפון']) ? data['כפילויות בטלפון'].length : 0}</strong> קבוצות כפילות</p>
                       ${Array.isArray(data['כפילויות בטלפון']) && data['כפילויות בטלפון'].length > 0 ? `
                           <details style="margin-top: 10px;">
                               <summary>הצג כפילויות</summary>
                               <ul style="margin-top: 10px;">
                                   ${data['כפילויות בטלפון'].slice(0, 10).map(dup => 
                                       `<li>${dup.phone} - ${dup.count} פעמים</li>`
                                   ).join('')}
                                   ${data['כפילויות בטלפון'].length > 10 ? '<li>...ועוד</li>' : ''}
                               </ul>
                           </details>
                       ` : ''}
                   </div>
               </div>
               
               <div style="text-align: center; margin-top: 25px;">
                   <button class="btn btn-warning" onclick="cleanupDuplicates(); this.closest('.modal').remove();">
                       🧹 נקה כפילויות
                   </button>
                   <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                       ❌ סגור
                   </button>
               </div>
           </div>
       </div>
   `;
   document.body.appendChild(modal);
}

// ניקוי כפילויות
async function cleanupDuplicates() {
   if (!confirm('האם אתה בטוח שברצונך לנקות כפילויות? פעולה זו תשמור רק את הרשומה החדשה ביותר מכל קבוצה.')) {
       return;
   }
   
   try {
       const response = await fetch('/api/admin/cleanup-duplicates', {
           method: 'POST',
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       const data = await response.json();
       
       if (response.ok) {
           showNotification(`${data.removed} כפילויות הוסרו בהצלחה! 🧹`, 'success');
           loadDonors(); // רענון הרשימה
       } else {
           showNotification(data.error || 'שגיאה בניקוי כפילויות', 'error');
       }
   } catch (error) {
       showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

// === פונקציות לוגי מערכת ===

// טעינת לוגים
async function loadLogs() {
   try {
       showLoading('logsTableBody');
       
       const params = new URLSearchParams();
       const userFilter = document.getElementById('logUserFilter')?.value;
       const actionFilter = document.getElementById('logActionFilter')?.value;
       const fromDate = document.getElementById('logFromDate')?.value;
       const toDate = document.getElementById('logToDate')?.value;
       
       if (userFilter) params.append('user_id', userFilter);
       if (actionFilter) params.append('action', actionFilter);
       if (fromDate) params.append('from_date', fromDate);
       if (toDate) params.append('to_date', toDate);
       
       const response = await fetch(`/api/admin/logs?${params.toString()}`, {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (response.ok) {
           const data = await response.json();
           displayLogs(data.logs);
           updateLogsPagination(data);
       } else {
           throw new Error('שגיאה בטעינת לוגים');
       }
   } catch (error) {
       console.error('❌ שגיאה בטעינת לוגים:', error);
       document.getElementById('logsTableBody').innerHTML = 
           '<tr><td colspan="7" class="text-center">שגיאה בטעינת נתונים</td></tr>';
   }
}

function displayLogs(logs) {
   const tbody = document.getElementById('logsTableBody');
   
   if (logs.length === 0) {
       tbody.innerHTML = `
           <tr>
               <td colspan="7" class="text-center">
                   <div class="empty-state">
                       <div class="empty-state-icon">📋</div>
                       <h3>אין לוגים להצגה</h3>
                       <p>נסה לשנות את הסינונים</p>
                   </div>
               </td>
           </tr>
       `;
       return;
   }
   
   tbody.innerHTML = logs.map(log => `
       <tr>
           <td>${new Date(log.created_at).toLocaleString('he-IL')}</td>
           <td>${log.full_name || log.username || 'לא ידוע'}</td>
           <td>
               <span class="badge ${getActionBadge(log.action)}">
                   ${getActivityText(log.action)}
               </span>
           </td>
           <td>${log.target_type || ''}</td>
           <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
               ${log.details || ''}
           </td>
           <td>${log.ip_address || ''}</td>
           <td style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
               ${log.user_agent ? log.user_agent.split(' ')[0] : ''}
           </td>
       </tr>
   `).join('');
}

function getActionBadge(action) {
   const badgeMap = {
       'LOGIN_SUCCESS': 'badge-success',
       'LOGIN_FAILED': 'badge-danger',
       'SEARCH': 'badge-info',
       'CREATE_DONOR': 'badge-success',
       'UPDATE_DONOR': 'badge-warning',
       'DELETE_DONOR': 'badge-danger',
       'CSV_UPLOAD': 'badge-success',
       'CREATE_USER': 'badge-success',
       'UPDATE_USER': 'badge-warning',
       'DELETE_USER': 'badge-danger'
   };
   return badgeMap[action] || 'badge-secondary';
}

function updateLogsPagination(data) {
   // עדכון עמודונים ללוגים
   updatePagination('logsPagination', data.total);
}

// סינון לוגים
function filterLogs() {
   loadLogs();
}

// ניקוי לוגים ישנים
async function clearOldLogs() {
   const days = prompt('מחק לוגים הישנים מכמה ימים? (ברירת מחדל: 90)');
   const daysOld = parseInt(days) || 90;
   
   if (!confirm(`האם אתה בטוח שברצונך למחוק לוגים הישנים מ-${daysOld} ימים?`)) {
       return;
   }
   
   try {
       const response = await fetch('/api/admin/logs/cleanup', {
           method: 'DELETE',
           headers: {
               'Content-Type': 'application/json',
               'Authorization': `Bearer ${authToken}`
           },
           body: JSON.stringify({ days_old: daysOld })
       });
       
       const data = await response.json();
       
       if (response.ok) {
           showNotification(`${data.deleted} רשומות לוג נוקו בהצלחה! 🗑️`, 'success');
           loadLogs();
       } else {
           showNotification(data.error || 'שגיאה בניקוי לוגים', 'error');
       }
   } catch (error) {
       showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

// ייצוא לוגים
async function exportLogs() {
   try {
       const params = new URLSearchParams();
       const userFilter = document.getElementById('logUserFilter')?.value;
       const actionFilter = document.getElementById('logActionFilter')?.value;
       const fromDate = document.getElementById('logFromDate')?.value;
       const toDate = document.getElementById('logToDate')?.value;
       
       if (userFilter) params.append('user_id', userFilter);
       if (actionFilter) params.append('action', actionFilter);
       if (fromDate) params.append('from_date', fromDate);
       if (toDate) params.append('to_date', toDate);
       
       const response = await fetch(`/api/admin/export/logs?${params.toString()}`, {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (response.ok) {
           const blob = await response.blob();
           const url = window.URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = 'system_logs_export.csv';
           document.body.appendChild(a);
           a.click();
           window.URL.revokeObjectURL(url);
           document.body.removeChild(a);
           showNotification('לוגים יוצאו בהצלחה! 📋', 'success');
       } else {
           showNotification('שגיאה בייצוא לוגים', 'error');
       }
   } catch (error) {
       showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

// === פונקציות מערכת כלליות ===

// רענון פעילות
function refreshActivity() {
   loadRecentActivity();
   showNotification('פעילות רוענה! 🔄', 'info');
}

// הגדרות מערכת
function showSystemSettings() {
   const modal = document.createElement('div');
   modal.className = 'modal show';
   modal.innerHTML = `
       <div class="modal-content">
           <div class="modal-header">
               <h3>⚙️ הגדרות מערכת</h3>
               <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
           </div>
           <div>
               <div class="message info">
                   <span>🔧 הגדרות מערכת ותחזוקה</span>
               </div>
               
               <div class="form-group">
                   <label>🗑️ ניקוי נתונים:</label>
                   <div style="margin: 10px 0;">
                       <button class="btn btn-warning" onclick="clearOldLogs(); this.closest('.modal').remove();">
                           📋 נקה לוגים ישנים
                       </button>
                       <button class="btn btn-warning" onclick="cleanupDuplicates(); this.closest('.modal').remove();">
                           🔄 נקה כפילויות
                       </button>
                   </div>
               </div>
               
               <div class="form-group">
                   <label>💾 גיבוי ושחזור:</label>
                   <div style="margin: 10px 0;">
                       <button class="btn btn-info" onclick="createBackup(); this.closest('.modal').remove();">
                           💾 צור גיבוי
                       </button>
                       <button class="btn btn-success" onclick="checkSystemHealth(); this.closest('.modal').remove();">
                           🏥 בדוק תקינות מערכת
                       </button>
                   </div>
               </div>
               
               <div class="form-group">
                   <label>📊 ייצוא נתונים:</label>
                   <div style="margin: 10px 0;">
                       <button class="btn btn-secondary" onclick="exportDonors();">
                           👥 ייצא תורמים
                       </button>
                       <button class="btn btn-secondary" onclick="exportReports();">
                           📈 ייצא דוחות
                       </button>
                       <button class="btn btn-secondary" onclick="exportLogs();">
                           📋 ייצא לוגים
                       </button>
                   </div>
               </div>
           </div>
       </div>
   `;
   document.body.appendChild(modal);
}

// יצירת גיבוי
async function createBackup() {
   try {
       const response = await fetch('/api/admin/backup', {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       const data = await response.json();
       
       if (response.ok) {
           showNotification(`גיבוי נוצר בהצלחה! 💾\nנשמר ב: ${data.backupPath}`, 'success');
       } else {
           showNotification(data.error || 'שגיאה ביצירת גיבוי', 'error');
       }
   } catch (error) {
       showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

// בדיקת תקינות מערכת
async function checkSystemHealth() {
   try {
       const response = await fetch('/api/admin/system-health', {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (response.ok) {
           const data = await response.json();
           displaySystemHealthModal(data);
       } else {
           showNotification('שגיאה בבדיקת תקינות', 'error');
       }
   } catch (error) {
       showNotification('שגיאת תקשורת עם השרת', 'error');
   }
}

function displaySystemHealthModal(data) {
   const modal = document.createElement('div');
   modal.className = 'modal show';
   modal.innerHTML = `
       <div class="modal-content">
           <div class="modal-header">
               <h3>🏥 בדיקת תקינות מערכת</h3>
               <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
           </div>
           <div>
               <div class="message ${data.overallStatus === 'HEALTHY' ? 'success' : data.overallStatus === 'WARNING' ? 'warning' : 'error'}">
                   <span>📊 סטטוס כללי: <strong>${getHealthStatusText(data.overallStatus)}</strong></span>
               </div>
               
               <div style="margin: 20px 0;">
                   <h4>🔍 בדיקות מערכת:</h4>
                   
                   ${data.checks.map(check => `
                       <div class="card" style="margin: 10px 0; padding: 15px;">
                           <div style="display: flex; justify-content: space-between; align-items: center;">
                               <h5>${check.component}</h5>
                               <span class="badge ${getHealthBadge(check.status)}">
                                   ${check.status}
                               </span>
                           </div>
                           <p style="margin: 5px 0 0 0;">${check.message}</p>
                       </div>
                   `).join('')}
               </div>
               
               <div style="text-align: center; margin-top: 25px;">
                   <small class="text-muted">
                       📅 נבדק ב: ${new Date(data.timestamp).toLocaleString('he-IL')}
                   </small>
               </div>
           </div>
       </div>
   `;
   document.body.appendChild(modal);
}

function getHealthStatusText(status) {
   const statusMap = {
       'HEALTHY': 'תקין ✅',
       'WARNING': 'אזהרה ⚠️',
       'UNHEALTHY': 'לא תקין ❌'
   };
   return statusMap[status] || status;
}

function getHealthBadge(status) {
   const badgeMap = {
       'OK': 'badge-success',
       'WARNING': 'badge-warning',
       'ERROR': 'badge-danger'
   };
   return badgeMap[status] || 'badge-secondary';
}

// סקירת כרטיסים
function showTicketsOverview() {
   showTab('tickets');
}

// בדיקת תקינות מערכת מהיר
function showSystemHealth() {
   checkSystemHealth();
}

// ייצוא נתוני מערכת
function exportSystemData() {
   showSystemSettings();
}

// === עזרים נוספים ===

// הודעה לעדכון זמן אמת
setInterval(() => {
   // עדכון זמן אמת של נתונים בלוח הבקרה אם אנחנו בלשונית dashboard
   const activeTab = document.querySelector('.nav-tab.active');
   if (activeTab && activeTab.textContent.includes('לוח בקרה')) {
       loadDashboardData();
   }
}, 300000); // כל 5 דקות

// הוספת קיצורי מקלדת
document.addEventListener('keydown', function(e) {
   // Ctrl/Cmd + Shift + N = משתמש חדש
   if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'N') {
       e.preventDefault();
       showAddUserModal();
   }
   
   // Ctrl/Cmd + Shift + D = תורם חדש
   if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
       e.preventDefault();
       showAddDonorModal();
   }
   
   // Ctrl/Cmd + Shift + M = הודעה חדשה
   if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'M') {
       e.preventDefault();
       showCreateMessageModal();
   }
   
   // Escape = סגירת מודלים
   if (e.key === 'Escape') {
       const openModals = document.querySelectorAll('.modal.show');
       openModals.forEach(modal => {
           modal.classList.remove('show');
           document.body.style.overflow = 'auto';
       });
   }
});

// בדיקת חיבור תקופתית
setInterval(async () => {
   try {
       const response = await fetch('/api/admin/dashboard', {
           headers: { 'Authorization': `Bearer ${authToken}` }
       });
       
       if (!response.ok) {
           if (response.status === 401 || response.status === 403) {
               showNotification('החיבור פג תוקף - מפנה לדף התחברות', 'warning');
               setTimeout(() => logout(), 2000);
           }
       }
   } catch (error) {
       console.warn('⚠️ בעיית חיבור זמנית לשרת');
   }
}, 300000); // כל 5 דקות

// פונקציה לסינכרון ידני
async function manualAirtableSync() {
    const button = document.getElementById('syncButton');
    const status = document.getElementById('syncStatus');
    
    // השבתת כפתור ומצב טעינה
    button.disabled = true;
    button.innerHTML = '🔄 מסנכרן...';
    status.innerHTML = '<div class="message info">🔄 מתחיל סינכרון עם Airtable...</div>';
    
    try {
        const response = await fetch('/api/admin/sync-airtable', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            status.innerHTML = `
                <div class="message success">
                    <h4>✅ סינכרון הושלם בהצלחה!</h4>
                    <ul>
                        <li>📊 סה"כ עובדו: ${data.details.totalProcessed} רשומות</li>
                        <li>🆕 חדשים: ${data.details.newRecords}</li>
                        <li>✏️ עודכנו: ${data.details.updatedRecords}</li>
                        <li>➡️ ללא שינוי: ${data.details.unchangedRecords}</li>
                        <li>❌ שגיאות: ${data.details.errors}</li>
                    </ul>
                </div>
            `;
            
            // רענון דף התורמים אם פתוח
            if (window.loadDonors) {
                setTimeout(() => loadDonors(), 1000);
            }
        } else {
            status.innerHTML = `
                <div class="message error">
                    <h4>❌ שגיאה בסינכרון</h4>
                    <p>${data.error}</p>
                    <small>${data.details || ''}</small>
                </div>
            `;
        }
    } catch (error) {
        status.innerHTML = `
            <div class="message error">
                <h4>❌ שגיאת תקשורת</h4>
                <p>לא ניתן להתחבר לשרת</p>
            </div>
        `;
    } finally {
        // החזרת כפתור למצב רגיל
        button.disabled = false;
        button.innerHTML = '🔄 עדכן תורמים מ-Airtable עכשיו';
    }
}

console.log('✅ כל הפונקציות נוספו לפאנל האדמין בהצלחה!');
   </script>
</body>
</html>